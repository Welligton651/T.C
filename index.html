<!doctype html>
<html lang="pt-BR">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Controle de Tráfego</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* TODO: SEU CSS INTEIRO VAI AQUI... */
    /* (Ocultado para brevidade, pois não foi alterado) */
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #253d70 0%, #1e2a54 100%);
      min-height: 100%;
      padding: 2rem 1rem;
    }

    * {
      box-sizing: border-box;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .login-container {
      max-width: 450px;
      margin: 0 auto;
      margin-top: 8%;
    }

    .header {
      text-align: center;
      color: white;
      margin-bottom: 2rem;
      position: relative;
    }

    .header h1 {
      font-size: 2rem;
      font-weight: 700;
      margin: 0 0 0.5rem 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 1rem;
    }

    .header .logo-icon {
      width: 40px;
      height: 40px;
      fill: white;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
    }

    .header p {
      font-size: 1rem;
      opacity: 0.9;
      margin: 0;
    }

    .header-with-weather {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 2rem;
      align-items: start;
      max-width: 1200px;
      margin: 0 auto 2rem auto;
    }

    .header-content {
      text-align: center;
      color: white;
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 2rem;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      margin-bottom: 2rem;
    }

    .login-card {
      background: linear-gradient(163deg, #00ff75 0%, #3700ff 100%);
      border-radius: 22px;
      transition: all 0.3s;
      padding: 0;
      overflow: hidden;
    }

    .login-card:hover {
      box-shadow: 0px 0px 30px 1px rgba(0, 255, 117, 0.3);
    }

    .login-card-inner {
      background: #ffffff;
      border-radius: 20px;
      padding: 2rem;
      margin: 5px;
      transition: all 0.2s;
    }

    .login-card-inner:hover {
      transform: scale(0.98);
    }

    .login-card h2 {
      color: #1e293b;
      margin: 2rem 0;
      font-size: 1.2rem;
      font-weight: 700;
      text-align: center;
    }

    .tabs {
      display: flex;
      border-bottom: 2px solid #e5e7eb;
      margin-bottom: 2rem;
      margin-left: -1.5rem;
      margin-right: -1.5rem;
    }

    .tab-btn {
      flex: 1;
      padding: 1rem;
      border: none;
      background: transparent;
      color: #6b7280;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      border-bottom: 2px solid transparent;
    }

    .tab-btn:hover {
      color: #374151;
      background: #f9fafb;
    }

    .tab-btn.active {
      color: #253d70;
      border-bottom-color: #253d70;
      background: #f8faff;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .sync-status {
      background: #f0f9ff;
      border: 1px solid #0ea5e9;
      border-radius: 8px;
      padding: 0.75rem;
      margin-bottom: 1rem;
      font-size: 0.875rem;
      display: none;
    }

    .sync-status.show {
      display: block;
    }

    .sync-status.syncing {
      background: #fef3c7;
      border-color: #f59e0b;
    }

    .sync-status.success {
      background: #f0fdf4;
      border-color: #22c55e;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      text-align: left;
    }

    .form-group label {
      font-weight: 600;
      color: #374151;
      margin-bottom: 0.5rem;
      font-size: 0.875rem;
    }

    .form-group input, .form-group textarea {
      padding: 0.75rem;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 1rem;
      transition: all 0.2s;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }

    .form-group input:focus, .form-group textarea:focus {
      outline: none;
      border-color: #253d70;
      box-shadow: 0 0 0 3px rgba(37, 61, 112, 0.1);
    }

    .field {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5em;
      background-color: #f8fafc;
      border-radius: 25px;
      padding: 0.6em;
      border: 2px solid #e2e8f0;
      outline: none;
      transition: all 0.3s;
      margin-bottom: 1rem;
    }

    .field:focus-within {
      border-color: #00ff75;
      box-shadow: 0 0 0 3px rgba(0, 255, 117, 0.1);
      background-color: #ffffff;
    }

    .input-icon {
      height: 1.3em;
      width: 1.3em;
      fill: #64748b;
      flex-shrink: 0;
    }

    .input-field {
      background: none;
      border: none;
      outline: none;
      width: 100%;
      color: #1e293b;
      font-size: 1rem;
      padding: 0.5rem;
    }

    .input-field::placeholder {
      color: #94a3b8;
    }

    .form-group input:disabled {
      background-color: #f9fafb;
      color: #6b7280;
    }

    .form-group small {
      color: #6b7280;
      font-size: 0.75rem;
      margin-top: 0.25rem;
      display: block;
    }

    .button-group {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .btn {
      flex: 1;
      min-width: 200px;
      padding: 0.875rem 1.5rem;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-primary {
      background: #253d70;
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      background: #1e2a54;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(37, 61, 112, 0.4);
    }

    .btn-secondary {
      background: #10b981;
      color: white;
    }

    .btn-secondary:hover:not(:disabled) {
      background: #059669;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
    }

    .btn-danger {
      background: #ef4444;
      color: white;
    }

    .btn-danger:hover:not(:disabled) {
      background: #dc2626;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
    }

    .btn-logout {
      background: #6b7280;
      color: white;
      min-width: auto;
      flex: none;
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
    }

    .btn-logout:hover:not(:disabled) {
      background: #4b5563;
    }

    .user-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding: 1rem;
      background: #f9fafb;
      border-radius: 8px;
    }

    .user-info span {
      color: #374151;
      font-weight: 600;
    }

    .user-details {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .user-details .location {
      font-size: 0.875rem;
      color: #6b7280;
      font-weight: normal;
    }

    .manager-profile {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    /* Manager Card Styles */
    .manager-card-container {
      display: flex;
      justify-content: center;
      margin-bottom: 2rem;
    }

    .manager-card {
      position: relative;
      width: 190px;
      height: 254px;
      background: linear-gradient(-45deg, #161616 0%, #000000 100%);
      color: #81818144;
      display: flex;
      flex-direction: column;
      justify-content: end;
      padding: 14px;
      gap: 10px;
      border-radius: 8px;
      cursor: pointer;
    }

    .manager-card::before {
      content: "";
      position: absolute;
      inset: 0;
      left: 0;
      margin: auto;
      width: 190px;
      height: 260px;
      border-radius: 10px;
      background: linear-gradient(-45deg, #253d70 0%, #1e2a54 40%);
      z-index: -10;
      pointer-events: none;
      transition: all 0.8s cubic-bezier(0.175, 0.95, 0.9, 1.275);
      box-shadow: 0px 20px 30px hsla(0, 0%, 0%, 0.521);
    }

    .manager-card::after {
      content: "";
      z-index: -1;
      position: absolute;
      inset: 0;
      width: 165px;
      height: 245px;
      background: linear-gradient(-45deg, #2d4a7c 0%, #253d70 100%);
      transform: translate3d(0, 0, 0) scale(0.45);
    }

    .manager-card .heading {
      font-size: 20px;
      text-transform: capitalize;
      font-weight: 900;
      color: white;
    }

    .manager-card p:not(.heading) {
      font-size: 14px;
      color: #cbd5e1;
    }

    .manager-card p:last-child {
      color: #60a5fa;
      font-weight: 900;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .manager-card:hover::after {
      transition: all 0.2s cubic-bezier(0.175, 0.285, 0.82, 1.275);
    }

    .manager-card:hover::before {
      transform: scaleX(1.02) scaleY(1.02);
      box-shadow: 0px 0px 30px 0px hsla(220, 50%, 50%, 0.5);
    }

    .profile-photo-container {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .profile-photo {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, #253d70 0%, #1e2a54 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      overflow: hidden;
      border: 3px solid white;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .profile-photo:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
    }

    .profile-photo img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 50%;
    }

    .photo-upload-btn {
      position: absolute;
      bottom: -2px;
      right: -2px;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: #10b981;
      border: 2px solid white;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      font-size: 0;
    }

    .photo-upload-btn:hover {
      background: #059669;
      transform: scale(1.1);
    }

    .photo-upload-btn svg {
      width: 12px;
      height: 12px;
    }

    .table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .table-header h2 {
      font-size: 1.5rem;
      color: #374151;
      margin: 0;
    }

    .table-actions {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .table-actions .btn {
      min-width: auto;
      flex: none;
    }

    .table-container {
      overflow-x: auto;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
    }

    thead {
      background: #f9fafb;
    }

    th {
      padding: 1rem;
      text-align: left;
      font-weight: 600;
      color: #374151;
      font-size: 0.875rem;
      border-bottom: 2px solid #e5e7eb;
      white-space: nowrap;
    }

    td {
      padding: 1rem;
      border-bottom: 1px solid #e5e7eb;
      color: #6b7280;
      font-size: 0.875rem;
    }

    tbody tr:hover {
      background: #f9fafb;
    }

    .status-badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .status-pendente {
      background: #fef3c7;
      color: #92400e;
    }

    .status-enviado {
      background: #d1fae5;
      color: #065f46;
    }

    .status-erro {
      background: #fee2e2;
      color: #991b1b;
    }

    .module-badge {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .module-manual {
      background: #ddd6fe;
      color: #5b21b6;
    }

    .checkbox-cell {
      width: 40px;
      text-align: center;
    }

    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .empty-state {
      text-align: center;
      padding: 3rem 1rem;
      color: #9ca3af;
    }

    .empty-state svg {
      width: 64px;
      height: 64px;
      margin: 0 auto 1rem;
      opacity: 0.5;
    }

    .toast {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      background: white;
      padding: 1rem 1.5rem;
      border-radius: 8px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      display: flex;
      align-items: center;
      gap: 0.75rem;
      z-index: 1000;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .toast.success {
      border-left: 4px solid #10b981;
    }

    .toast.error {
      border-left: 4px solid #ef4444;
    }

    .spinner {
      border: 2px solid #f3f4f6;
      border-top: 2px solid currentColor;
      border-radius: 50%;
      width: 16px;
      height: 16px;
      animation: spin 0.6s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .hidden {
      display: none !important;
    }

    /* Dashboard Styles */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .dashboard-card {
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      border-radius: 12px;
      padding: 1.5rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      border: 1px solid #e2e8f0;
      transition: all 0.2s;
    }

    .dashboard-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    }

    .dashboard-icon {
      background: white;
      border-radius: 12px;
      padding: 1rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .dashboard-content h3 {
      font-size: 2rem;
      font-weight: 700;
      color: #1e293b;
      margin: 0 0 0.25rem 0;
    }

    .dashboard-content p {
      font-size: 0.875rem;
      color: #64748b;
      margin: 0;
      font-weight: 500;
    }

    /* Ranking Styles */
    .ranking-container {
      background: #f8fafc;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid #e2e8f0;
    }

    .ranking-item {
      display: grid;
      grid-template-columns: 60px 1fr 150px 120px 80px 120px;
      gap: 1rem;
      padding: 1rem;
      align-items: center;
      border-bottom: 1px solid #e2e8f0;
    }

    .ranking-item:last-child {
      border-bottom: none;
    }

    .ranking-header {
      background: #1e293b;
      color: white;
      font-weight: 600;
      font-size: 0.875rem;
    }

    .ranking-item:not(.ranking-header):hover {
      background: white;
    }

    .ranking-position {
      font-weight: 700;
      font-size: 1.25rem;
      text-align: center;
    }

    .ranking-position.gold {
      color: #f59e0b;
    }

    .ranking-position.silver {
      color: #6b7280;
    }

    .ranking-position.bronze {
      color: #d97706;
    }

    .ranking-driver {
      font-weight: 600;
      color: #1e293b;
    }

    .ranking-location {
      color: #64748b;
      font-size: 0.875rem;
    }

    .ranking-metric {
      font-weight: 600;
      color: #059669;
    }

    .ranking-reports {
      text-align: center;
      color: #374151;
    }

    .ranking-avg {
      text-align: center;
      color: #6366f1;
      font-weight: 500;
    }

    /* Filter Styles */
    .ranking-filters,
    .table-filters {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .filter-select {
      padding: 0.5rem 1rem;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      background: white;
      color: #374151;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .filter-select:focus {
      outline: none;
      border-color: #253d70;
      box-shadow: 0 0 0 3px rgba(37, 61, 112, 0.1);
    }

    .empty-ranking {
      text-align: center;
      padding: 2rem;
      color: #9ca3af;
      grid-column: 1 / -1;
    }

    /* Weather Card Styles */
    .weather-card {
      display: flex;
      flex-direction: column;
      align-items: center;
      height: 140px;
      width: 240px;
      border-radius: 20px;
      background: lightgrey;
      overflow: hidden;
      transition: 100ms ease;
      box-shadow: rgba(0, 0, 0, 0.3) 3px 4px 8px;
    }

    .info-section {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      height: 75%;
      color: white;
    }

    .left-side {
      display: flex;
      flex-direction: column;
      justify-content: space-around;
      height: 100%;
      z-index: 1;
      padding-left: 18px;
    }

    .weather-info {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 5px;
    }

    .weather-info div {
      display: flex;
      align-items: center;
    }

    .weather-info div:nth-child(1) {
      width: 35%;
      height: auto;
    }

    .weather-info svg {
      width: 45px;
      height: 45px;
    }

    .temperature {
      font-size: 28pt;
      font-weight: 500;
      line-height: 8%;
    }

    .right-side {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      justify-content: space-around;
      height: 100%;
      padding-right: 14px;
      z-index: 1;
    }

    .right-side > div {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }

    .hour {
      font-size: 16pt;
      line-height: 1em;
    }

    .date {
      font-size: 12px;
    }

    .background-design {
      position: absolute;
      height: 100%;
      width: 100%;
      background-color: #ec7263;
      overflow: hidden;
    }

    .circle {
      background-color: #efc745;
    }

    .circle:nth-child(1) {
      position: absolute;
      top: -80%;
      right: -50%;
      width: 250px;
      height: 250px;
      opacity: 0.4;
      border-radius: 50%;
    }

    .circle:nth-child(2) {
      position: absolute;
      top: -70%;
      right: -30%;
      width: 180px;
      height: 180px;
      opacity: 0.4;
      border-radius: 50%;
    }

    .circle:nth-child(3) {
      position: absolute;
      top: -35%;
      right: -8%;
      width: 80px;
      height: 80px;
      opacity: 1;
      border-radius: 50%;
    }

    .days-section {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      height: 25%;
      background-color: #974859;
      gap: 2px;
      box-shadow: inset 0px 2px 5px #974859;
    }

    .days-section button {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      width: 100%;
      background-color: #a75265;
      box-shadow: inset 0px 2px 5px #974859;
      cursor: pointer;
      transition: 100ms ease;
      gap: 3px;
      border: none;
    }

    .days-section button:hover {
      scale: 0.9;
      border-radius: 8px;
    }

    .days-section .day {
      font-size: 8pt;
      font-weight: 500;
      color: white;
      opacity: 0.7;
    }

    .icon-weather-day {
      display: flex;
      align-items: center;
      width: 14px;
      height: 100%;
    }

    .icon-weather-day svg {
      width: 14px;
      height: 14px;
    }

    .location-name {
      font-size: 9pt;
      font-weight: 600;
      opacity: 0.9;
    }

    .btn-link {
      background-color: #f1f5f9;
      border: none;
      color: #475569;
      text-decoration: none;
      cursor: pointer;
      font-size: 0.875rem;
      padding: 0.5em;
      margin-bottom: 3em;
      transition: 0.4s ease-in-out;
      border-radius: 5px;
      font-weight: 600;
      display: inline-block;
      width: 100%;
    }

    .btn-link:hover {
      background-color: #ef4444;
      color: white;
    }

    .login-buttons {
      display: flex;
      justify-content: center;
      flex-direction: row;
      gap: 0.5rem;
      margin-top: 2.5rem;
      margin-bottom: 1rem;
    }

    .login-buttons .btn {
      padding: 0.5em 1.1em;
      border-radius: 8px;
      border: none;
      outline: none;
      transition: 0.4s ease-in-out;
      background-color: #253d70;
      color: white;
      font-weight: 600;
    }

    .login-buttons .btn:hover:not(:disabled) {
      background-color: #1e2a54;
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(37, 61, 112, 0.4);
    }

    .login-buttons .btn-primary {
      background-color: #253d70;
    }

    .login-buttons .btn-primary:hover:not(:disabled) {
      background-color: #1e2a54;
    }

    .login-buttons .btn-secondary {
      background-color: #10b981;
      padding: 0.5em 2.3em;
    }

    .login-buttons .btn-secondary:hover:not(:disabled) {
      background-color: #059669;
    }

    /* Reports Controls Styles */
    .reports-controls {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .search-filters {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
    }

    .export-buttons {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .export-buttons .btn {
      min-width: auto;
      flex: none;
    }

    /* BI Analytics Styles */
    .bi-analytics-section {
      margin-top: 2rem;
    }

    .analytics-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .analytics-controls {
      display: flex;
      gap: 1rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 2rem;
      margin-bottom: 2rem;
    }

    .chart-card {
      min-height: 350px;
      display: flex;
      flex-direction: column;
    }

    .chart-card.full-width {
      grid-column: 1 / -1;
      min-height: 200px;
    }

    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid #e5e7eb;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .chart-header h3 {
      margin: 0;
      color: #1e293b;
      font-size: 1.125rem;
      font-weight: 600;
    }

    .chart-legend {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
      color: #64748b;
    }

    .legend-color {
      width: 12px;
      height: 12px;
      border-radius: 2px;
    }

    .chart-info {
      font-size: 0.875rem;
      color: #64748b;
      font-weight: 500;
    }

    .chart-container {
      flex: 1;
      position: relative;
      min-height: 250px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .chart-container canvas {
      max-width: 100%;
      max-height: 100%;
    }

    /* Heatmap Styles */
    .heatmap-legend {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.75rem;
      color: #64748b;
    }

    .heatmap-scale {
      display: flex;
      gap: 2px;
    }

    .heatmap-cell {
      width: 10px;
      height: 10px;
      border-radius: 2px;
    }

    .heatmap-cell.level-0 { background: #f1f5f9; }
    .heatmap-cell.level-1 { background: #cbd5e1; }
    .heatmap-cell.level-2 { background: #94a3b8; }
    .heatmap-cell.level-3 { background: #64748b; }
    .heatmap-cell.level-4 { background: #334155; }

    .heatmap-container {
      padding: 1rem;
      background: #f8fafc;
      border-radius: 8px;
      overflow-x: auto;
    }

    .heatmap-grid {
      display: grid;
      grid-template-columns: repeat(53, 12px);
      gap: 2px;
      min-width: 700px;
    }

    .heatmap-day {
      width: 12px;
      height: 12px;
      border-radius: 2px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .heatmap-day:hover {
      transform: scale(1.2);
      border: 1px solid #334155;
    }

    .heatmap-tooltip {
      position: absolute;
      background: #1e293b;
      color: white;
      padding: 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      pointer-events: none;
      z-index: 1000;
      white-space: nowrap;
    }

    /* Performance Metrics */
    .performance-metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
    }

    .metric-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 1rem;
      background: #f8fafc;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
      transition: all 0.2s;
    }

    .metric-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .metric-icon {
      font-size: 1.5rem;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .metric-content {
      flex: 1;
    }

    .metric-value {
      font-size: 1.25rem;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 0.25rem;
    }

    .metric-label {
      font-size: 0.75rem;
      color: #64748b;
      font-weight: 500;
    }

    /* Location Analysis */
    .location-analysis {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .location-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem;
      background: #f8fafc;
      border-radius: 6px;
      border-left: 4px solid #3b82f6;
    }

    .location-name {
      font-weight: 600;
      color: #1e293b;
      font-size: 0.875rem;
    }

    .location-stats {
      display: flex;
      gap: 1rem;
      font-size: 0.75rem;
      color: #64748b;
    }

    .location-stat {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }

    .location-stat-value {
      font-weight: 600;
      color: #1e293b;
      font-size: 0.875rem;
    }

    /* Advanced Analytics */
    .advanced-controls {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .insights-panel {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }

    .insight-card {
      display: flex;
      align-items: flex-start;
      gap: 1rem;
      padding: 1.5rem;
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      border-radius: 12px;
      border: 1px solid #0ea5e9;
      transition: all 0.3s;
    }

    .insight-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(14, 165, 233, 0.15);
    }

    .insight-icon {
      font-size: 2rem;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      flex-shrink: 0;
    }

    .insight-content h4 {
      margin: 0 0 0.5rem 0;
      color: #0c4a6e;
      font-size: 1.125rem;
      font-weight: 600;
    }

    .insight-content p {
      margin: 0;
      color: #0369a1;
      font-size: 0.875rem;
      line-height: 1.5;
    }

    .insight-card.warning {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border-color: #f59e0b;
    }

    .insight-card.warning .insight-content h4 {
      color: #92400e;
    }

    .insight-card.warning .insight-content p {
      color: #d97706;
    }

    .insight-card.success {
      background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
      border-color: #10b981;
    }

    .insight-card.success .insight-content h4 {
      color: #065f46;
    }

    .insight-card.success .insight-content p {
      color: #047857;
    }

    .insight-card.danger {
      background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
      border-color: #ef4444;
    }

    .insight-card.danger .insight-content h4 {
      color: #991b1b;
    }

    .insight-card.danger .insight-content p {
      color: #dc2626;
    }

    /* Chart Loading State */
    .chart-loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 200px;
      color: #64748b;
    }

    .chart-loading .spinner {
      width: 32px;
      height: 32px;
      margin-bottom: 1rem;
    }

    /* Responsive Charts */
    @media (max-width: 768px) {
      .charts-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
      }

      .chart-card {
        min-height: 300px;
      }

      .analytics-header {
        flex-direction: column;
        align-items: stretch;
      }

      .analytics-controls {
        justify-content: center;
      }

      .performance-metrics {
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      }

      .metric-item {
        flex-direction: column;
        text-align: center;
        gap: 0.5rem;
      }

      .heatmap-container {
        padding: 0.5rem;
      }

      .location-stats {
        flex-direction: column;
        gap: 0.5rem;
      }

      .insights-panel {
        grid-template-columns: 1fr;
      }

      .insight-card {
        padding: 1rem;
      }

      .advanced-controls {
        flex-direction: column;
      }
    }

    /* Responsible Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 1rem;
    }

    .modal {
      background: white;
      border-radius: 12px;
      padding: 2rem;
      max-width: 500px;
      width: 100%;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
      text-align: center;
      margin-bottom: 1.5rem;
    }

    .modal-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 0.5rem;
    }

    .modal-subtitle {
      font-size: 0.875rem;
      color: #64748b;
    }

    .route-summary {
      background: #f8fafc;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1.5rem;
    }

    .route-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.5rem;
      font-size: 0.875rem;
    }

    .route-item:last-child {
      margin-bottom: 0;
    }

    .route-label {
      color: #64748b;
    }

    .route-value {
      font-weight: 600;
      color: #1e293b;
    }

    @media (max-width: 768px) {
      body {
        padding: 1rem 0.5rem;
      }

      .container {
        padding: 0 0.5rem;
      }

      .login-container {
        margin-top: 4%;
        padding: 0 0.5rem;
      }

      .header h1 {
        font-size: 1.25rem;
        flex-direction: row;
        gap: 0.5rem;
      }

      .header .logo-icon {
        width: 28px;
        height: 28px;
      }

      .header p {
        font-size: 0.875rem;
      }

      .card {
        padding: 1rem;
        margin-bottom: 1rem;
      }

      .login-card {
        padding: 1rem;
      }

      .form-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
      }

      .button-group {
        flex-direction: column;
        gap: 0.75rem;
      }

      .btn {
        min-width: auto;
        padding: 0.75rem 1rem;
        font-size: 0.875rem;
      }

      .table-header {
        flex-direction: column;
        align-items: stretch;
        gap: 1rem;
      }

      .table-actions {
        width: 100%;
      }

      .table-actions .btn {
        flex: 1;
        font-size: 0.875rem;
      }

      .user-info {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
        padding: 0.75rem;
      }

      .manager-profile {
        flex-direction: column;
        gap: 0.75rem;
        text-align: center;
      }

      .profile-photo {
        width: 50px;
        height: 50px;
      }

      .dashboard-grid {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
      }

      .dashboard-card {
        padding: 1rem;
        flex-direction: column;
        text-align: center;
        gap: 0.75rem;
      }

      .dashboard-content h3 {
        font-size: 1.5rem;
      }

      .ranking-item {
        grid-template-columns: 30px 1fr 60px 50px;
        gap: 0.5rem;
        font-size: 0.75rem;
        padding: 0.75rem;
      }

      .ranking-location,
      .ranking-avg {
        display: none;
      }

      .ranking-filters,
      .table-filters {
        flex-direction: column;
        gap: 0.75rem;
      }

      .search-filters {
        grid-template-columns: 1fr;
        gap: 0.75rem;
      }

      .export-buttons {
        flex-direction: column;
        gap: 0.75rem;
      }

      .export-buttons .btn {
        width: 100%;
      }

      .reports-controls {
        gap: 1rem;
      }

      .table-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      table {
        min-width: 800px;
      }

      th, td {
        padding: 0.5rem;
        font-size: 0.75rem;
        white-space: nowrap;
      }

      .modal {
        margin: 1rem;
        padding: 1.5rem;
        max-width: calc(100vw - 2rem);
      }

      .modal-title {
        font-size: 1.125rem;
      }

      .route-summary {
        padding: 0.75rem;
      }

      .tabs {
        margin-left: -1rem;
        margin-right: -1rem;
      }

      .tab-btn {
        padding: 0.75rem;
        font-size: 0.875rem;
      }

      .toast {
        bottom: 1rem;
        right: 1rem;
        left: 1rem;
        padding: 0.75rem 1rem;
        font-size: 0.875rem;
      }

      .header-with-weather {
        grid-template-columns: 1fr;
        gap: 1rem;
      }

      .weather-card {
        margin: 0 auto;
      }
    }

    @media (max-width: 480px) {
      .header h1 {
        font-size: 1.125rem;
      }

      .header .logo-icon {
        width: 24px;
        height: 24px;
      }

      .card {
        padding: 0.75rem;
      }

      .dashboard-grid {
        grid-template-columns: 1fr;
      }

      .ranking-item {
        grid-template-columns: 25px 1fr 50px;
        gap: 0.25rem;
        padding: 0.5rem;
      }

      .ranking-reports {
        display: none;
      }

      .btn {
        padding: 0.625rem 0.875rem;
        font-size: 0.8125rem;
      }

      .form-group label {
        font-size: 0.8125rem;
      }

      .form-group input,
      .form-group textarea,
      .filter-select {
        padding: 0.625rem;
        font-size: 0.875rem;
      }
    }
/* --- ESTILOS DO RODAPÉ (FOOTER) --- */
#app-footer {
  background-color: #f8fafc; /* Cinza bem claro */
  border-top: 1px solid #e2e8f0;
  padding: 1.5rem 1rem;
  margin-top: auto; /* Empurra para baixo se usar flex column no body */
  width: 100%;
  font-size: 0.75rem; /* Texto pequeno */
  color: #4b5563;
}

.footer-container {
  max-width: 1200px;
  margin: 0 auto;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: space-between;
  gap: 1rem;
}

@media (min-width: 768px) {
  .footer-container {
    flex-direction: row;
  }
  .footer-right {
    text-align: right;
  }
  .footer-left {
    margin-bottom: 0;
  }
}

.footer-left {
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.dev-photo-container {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  overflow: hidden;
  border: 2px solid #6366f1; /* Cor indigo */
  flex-shrink: 0;
}

.dev-photo {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.dev-info {
  display: flex;
  flex-direction: column;
  text-align: left;
}

.dev-name {
  font-weight: 600;
  color: #1f2937;
}

.dev-role {
  color: #4f46e5;
  font-size: 0.7rem;
}

.system-name {
  font-weight: 700;
  color: #374151;
  margin-bottom: 0.25rem;
  display: block;
}

.system-meta {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 0.75rem;
  color: #6b7280;
}

@media (min-width: 768px) {
  .system-meta {
    justify-content: flex-end;
  }
}

/* Ocultar na impressão */
@media print {
  #app-footer {
    display: none !important;
  }
}
  </style>
  <style>@view-transition { navigation: auto; }</style>
  </script>
 </head>
 <body>
  <div id="responsible-modal" class="modal-overlay hidden">
   <div class="modal">
    
    <div class="modal-header">
     <h3 class="modal-title">Atesto de Responsabilidade</h3>
     <p class="modal-subtitle">Informe o responsável da unidade que atesta as rotas selecionadas:</p>
    </div>
    
    <div class="form-group">
      <label for="responsible-name">Nome do Responsável</label> 
      <input type="text" id="responsible-name" required placeholder="Ex: João Silva Santos"> 
      <small>Nome completo do responsável pela unidade</small>
    </div>
    
    <div class="form-group">
      <label for="unit-type">Tipo de Unidade</label> 
      <select id="unit-type" required> 
        <option value="">Selecione o tipo de unidade</option> 
        <option value="CRAS">CRAS - Centro de Referência de Assistência Social</option> 
        <option value="CREAS">CREAS - Centro de Referência Especializado de Assistência Social</option> 
        <option value="Conselho Tutelar">Conselho Tutelar</option> 
        <option value="Outra Unidade">Outra Unidade</option> 
      </select>
    </div>
    
    <div class="form-group" id="km-final-day-group" style="display: none;">
      <label for="km-final-day">KM Final do Veículo (Atual)</label> 
      <input type="number" id="km-final-day" min="0" step="0.1" placeholder="KM atual do odômetro">
      <small>Este KM fechará a sua última rota do dia.</small>
    </div>

    <div class="route-summary">
     <div class="route-item">
       <span class="route-label">Registros selecionados:</span> 
       <span class="route-value" id="selected-count">0</span>
     </div>
     <div class="route-item">
       <span class="route-label">Total de quilometragem:</span> 
       <span class="route-value" id="selected-km">0 km</span>
     </div>
    </div>

    <div class="button-group">
      <button class="btn btn-secondary" id="confirm-responsible-btn">
       <svg width="20" height="20" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"></path></svg> Confirmar e Enviar 
      </button> 
      <button class="btn btn-danger" id="cancel-responsible-btn">
       <svg width="20" height="20" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"></path></svg> Cancelar 
      </button>
     </div>

   </div> </div> <div id="login-screen" class="login-container">
   <div class="header">
    <h1 id="page-title">
     <svg class="logo-icon" xmlns="http://www.w3.org/2000/svg" height="40" width="40" viewbox="0 0 640 640" fill="white"><path d="M541.9 139.5C546.4 127.7 543.6 114.3 534.7 105.4C525.8 96.5 512.4 93.6 500.6 98.2L84.6 258.2C71.9 263 63.7 275.2 64 288.7C64.3 302.2 73.1 314.1 85.9 318.3L262.7 377.2L321.6 554C325.9 566.8 337.7 575.6 351.2 575.9C364.7 576.2 376.9 568 381.8 555.4L541.8 139.4z" />
     </svg> Sistema de Controle de Tráfego</h1>
    <p id="department-name">COORDENAÇÃO DE SUPORTE E LOGÍSTICA - SEMCAS</p>
   </div>
   <div class="card login-card">
    <div class="login-card-inner"><div class="tabs"><button class="tab-btn active" id="login-tab" onclick="switchTab('login')">
       <svg width="16" height="16" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h4a2 2 0 012 2v14a2 2 0 01-2 2h-4M10 17l5-5-5-5M21 12H9" />
       </svg> Login </button> <button class="tab-btn" id="register-tab" onclick="switchTab('register')">
       <svg width="16" height="16" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2M12.5 7a4 4 0 11-8 0 4 4 0 018 0zM20 8v6M23 11h-6" />
       </svg> Cadastrar-se </button>
     </div><div id="login-content" class="tab-content active">
      <h2 id="login-title">Login</h2>
      <form id="login-form">
       <div class="field">
        <svg viewbox="0 0 16 16" fill="currentColor" height="16" width="16" xmlns="http://www.w3.org/2000/svg" class="input-icon"><path d="M13.106 7.222c0-2.967-2.249-5.032-5.482-5.032-3.35 0-5.646 2.318-5.646 5.702 0 3.493 2.235 5.708 5.762 5.708.862 0 1.689-.123 2.304-.335v-.862c-.43.199-1.354.328-2.29.328-2.926 0-4.813-1.88-4.813-4.798 0-2.844 1.921-4.881 4.594-4.881 2.735 0 4.608 1.688 4.608 4.156 0 1.682-.554 2.769-1.416 2.769-.492 0-.772-.28-.772-.76V5.206H8.923v.834h-.11c-.266-.595-.881-.964-1.6-.964-1.4 0-2.378 1.162-2.378 2.823 0 1.737.957 2.906 2.379 2.906.8 0 1.415-.39 1.709-1.087h.11c.081.67.703 1.148 1.503 1.148 1.572 0 2.57-1.415 2.57-3.643zm-7.177.704c0-1.197.54-1.907 1.456-1.907.93 0 1.524.738 1.524 1.907S8.308 9.84 7.371 9.84c-.895 0-1.442-.725-1.442-1.914z" />
        </svg><input type="email" class="input-field" id="username" required placeholder="Email" autocomplete="off">
       </div>
       <div class="field">
        <svg viewbox="0 0 16 16" fill="currentColor" height="16" width="16" xmlns="http://www.w3.org/2000/svg" class="input-icon"><path d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2zm3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z" />
        </svg><input type="password" class="input-field" id="password" required placeholder="Senha">
       </div><small style="display: block; text-align: center; color: #64748b; margin-bottom: 1rem; font-size: 0.8125rem;"> Use seu email e senha cadastrados </small>
       <div class="login-buttons"><button type="submit" class="btn btn-primary" id="login-btn">
         <svg width="20" height="20" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h4a2 2 0 012 2v14a2 2 0 01-2 2h-4M10 17l5-5-5-5M21 12H9" />
         </svg><span id="login-button-text">Entrar</span> </button>
       </div>
       <div style="text-align: center;"><button type="button" class="btn-link" id="forgot-password-btn" onclick="showForgotPassword()"> Esqueceu a senha? </button>
       </div>
      </form>
     </div><div id="forgot-password-content" class="tab-content">
      <h2>Recuperar Senha</h2>
      <form id="forgot-password-form">
       <div class="field">
        <svg viewbox="0 0 16 16" fill="currentColor" height="16" width="16" xmlns="http://www.w3.org/2000/svg" class="input-icon"><path d="M13.106 7.222c0-2.967-2.249-5.032-5.482-5.032-3.35 0-5.646 2.318-5.646 5.702 0 3.493 2.235 5.708 5.762 5.708.862 0 1.689-.123 2.304-.335v-.862c-.43.199-1.354.328-2.29.328-2.926 0-4.813-1.88-4.813-4.798 0-2.844 1.921-4.881 4.594-4.881 2.735 0 4.608 1.688 4.608 4.156 0 1.682-.554 2.769-1.416 2.769-.492 0-.772-.28-.772-.76V5.206H8.923v.834h-.11c-.266-.595-.881-.964-1.6-.964-1.4 0-2.378 1.162-2.378 2.823 0 1.737.957 2.906 2.379 2.906.8 0 1.415-.39 1.709-1.087h.11c.081.67.703 1.148 1.503 1.148 1.572 0 2.57-1.415 2.57-3.643zm-7.177.704c0-1.197.54-1.907 1.456-1.907.93 0 1.524.738 1.524 1.907S8.308 9.84 7.371 9.84c-.895 0-1.442-.725-1.442-1.914z" />
        </svg><input type="email" class="input-field" id="recovery-email" required placeholder="Email de Cadastro" autocomplete="off">
       </div><small style="display: block; text-align: center; color: #64748b; margin-bottom: 1rem; font-size: 0.8125rem;"> Digite o email que você usou para se cadastrar </small>
       <div class="login-buttons"><button type="submit" class="btn btn-secondary" id="recovery-btn">
         <svg width="20" height="20" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
         </svg><span id="recovery-button-text">Enviar Link</span> </button>
       </div>
       <div style="text-align: center;"><button type="button" class="btn-link" onclick="backToLogin()"> Voltar ao Login </button>
       </div>
      </form>
     </div><div id="register-content" class="tab-content">
      <h2 id="register-title">Cadastro</h2>
      <form id="register-form">
       <div class="field">
        <svg viewbox="0 0 16 16" fill="currentColor" height="16" width="16" xmlns="http://www.w3.org/2000/svg" class="input-icon"><path d="M3 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1H3zm5-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6z" />
        </svg><input type="text" class="input-field" id="reg-name" required placeholder="Nome Completo" autocomplete="off">
       </div><div class="field">
        <svg viewbox="0 0 16 16" fill="currentColor" height="16" width="16" xmlns="http://www.w3.org/2000/svg" class="input-icon"><path d="M13.106 7.222c0-2.967-2.249-5.032-5.482-5.032-3.35 0-5.646 2.318-5.646 5.702 0 3.493 2.235 5.708 5.762 5.708.862 0 1.689-.123 2.304-.335v-.862c-.43.199-1.354.328-2.29.328-2.926 0-4.813-1.88-4.813-4.798 0-2.844 1.921-4.881 4.594-4.881 2.735 0 4.608 1.688 4.608 4.156 0 1.682-.554 2.769-1.416 2.769-.492 0-.772-.28-.772-.76V5.206H8.923v.834h-.11c-.266-.595-.881-.964-1.6-.964-1.4 0-2.378 1.162-2.378 2.823 0 1.737.957 2.906 2.379 2.906.8 0 1.415-.39 1.709-1.087h.11c.081.67.703 1.148 1.503 1.148 1.572 0 2.57-1.415 2.57-3.643zm-7.177.704c0-1.197.54-1.907 1.456-1.907.93 0 1.524.738 1.524 1.907S8.308 9.84 7.371 9.84c-.895 0-1.442-.725-1.442-1.914z" />
        </svg><input type="email" class="input-field" id="reg-email" required placeholder="Email (para login)" autocomplete="off">
       </div>
       <div class="field">
        <svg viewbox="0 0 16 16" fill="currentColor" height="16" width="16" xmlns="http://www.w3.org/2000/svg" class="input-icon"><path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z" />
        </svg><input type="text" class="input-field" id="reg-nickname" placeholder="Apelido (opcional)" autocomplete="off">
       </div>
       <div class="field">
        <svg viewbox="0 0 16 16" fill="currentColor" height="16" width="16" xmlns="http://www.w3.org/2000/svg" class="input-icon"><path d="M12.166 8.94c-.524 1.062-1.234 2.12-1.96 3.07A31.493 31.493 0 0 1 8 14.58a31.481 31.481 0 0 1-2.206-2.57c-.726-.95-1.436-2.008-1.96-3.07C3.304 7.867 3 6.862 3 6a5 5 0 0 1 10 0c0 .862-.305 1.867-.834 2.94zM8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10z" /> <path d="M8 8a2 2 0 1 1 0-4 2 2 0 0 1 0 4zm0 1a3 3 0 1 0 0-6 3 3 0 0 0 0 6z" />
        </svg><input type="text" class="input-field" id="reg-location" required placeholder="Local de Lotação" autocomplete="off">
       </div>
       <div class="field">
        <svg viewbox="0 0 16 16" fill="currentColor" height="16" width="16" xmlns="http://www.w3.org/2000/svg" class="input-icon"><path d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2zm3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z" />
        </svg><input type="password" class="input-field" id="reg-password" required placeholder="Senha (mín. 6 dígitos)">
       </div>
       <div class="field">
        <svg viewbox="0 0 16 16" fill="currentColor" height="16" width="16" xmlns="http://www.w3.org/2000/svg" class="input-icon"><path d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2zm3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z" />
        </svg><input type="password" class="input-field" id="reg-password-confirm" required placeholder="Confirmar Senha">
       </div><small style="display: block; text-align: center; color: #64748b; margin-bottom: 1rem; font-size: 0.8125rem;"> A senha deve ter no mínimo 6 dígitos </small>
       <div class="login-buttons"><button type="submit" class="btn btn-secondary" id="register-btn">
         <svg width="20" height="20" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2M12.5 7a4 4 0 11-8 0 4 4 0 018 0z" />
         </svg><span id="register-button-text">Cadastrar</span> </button>
       </div>
      </form>
     </div>
    </div>
   </div>
  </div><div id="manager-screen" class="container hidden">
   <div class="header">
    <h1 id="manager-title">
     <svg class="logo-icon" xmlns="http://www.w3.org/2000/svg" height="40" width="40" viewbox="0 0 640 640" fill="white"><path d="M541.9 139.5C546.4 127.7 543.6 114.3 534.7 105.4C525.8 96.5 512.4 93.6 500.6 98.2L84.6 258.2C71.9 263 63.7 275.2 64 288.7C64.3 302.2 73.1 314.1 85.9 318.3L262.7 377.2L321.6 554C325.9 566.8 337.7 575.6 351.2 575.9C364.7 576.2 376.9 568 381.8 555.4L541.8 139.4z" />
     </svg> Dashboard Gerencial</h1>
    <p id="manager-department">COORDENAÇÃO DE SUPORTE E LOGÍSTICA - SEMCAS</p>
   </div>
   <div class="card">
    <div class="user-info">
     <div class="manager-profile">
      <div class="profile-photo-container">
       <div class="profile-photo" id="manager-photo">
  <img src="https://i.ibb.co/23ns06cH/me.jpg" alt="Foto do Gestor" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">
</div>
       <div class="photo-upload-btn" id="upload-photo-btn">
        <svg width="12" height="12" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z" /> <circle cx="12" cy="13" r="4" />
        </svg>
       </div><input type="file" id="photo-input" accept="image/*" style="display: none;">
      </div>
      <div class="user-details"><span id="manager-user-name"><strong>Welligton Luis</strong></span> <span class="location" id="manager-user-location">Gestor - Administração</span>
      </div>
     </div><button class="btn btn-logout" id="manager-logout-btn">
      <svg width="16" height="16" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4M16 17l5-5-5-5M21 12H9" />
      </svg> Sair </button>
    </div><div class="dashboard-grid">
<div class="dashboard-card" id="card-registered-drivers" style="cursor: pointer; border-left: 4px solid #6366f1;">
      <div class="dashboard-icon">
       <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#6366f1" stroke-width="2">
        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
        <circle cx="9" cy="7" r="4"></circle>
        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
       </svg>
      </div>
      <div class="dashboard-content">
       <h3 id="total-registered-drivers">0</h3>
       <p>Condutores Cadastrados <br><span style="font-size: 0.7em; color: #6366f1;">(Clique para detalhes)</span></p>
      </div>
     </div>
     <div class="dashboard-card">
      <div class="dashboard-icon">
       <svg width="32" height="32" viewbox="0 0 24 24" fill="none" stroke="#667eea" stroke-width="2"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
       </svg>
      </div>
      <div class="dashboard-content">
       <h3 id="total-reports">0</h3>
       <p>Total de Reports</p>
      </div>
     </div>
     <div class="dashboard-card">
      <div class="dashboard-icon">
       <svg width="32" height="32" viewbox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2"><path d="M20 6L9 17l-5-5" />
       </svg>
      </div>
      <div class="dashboard-content">
       <h3 id="sent-reports">0</h3>
       <p>Reports Enviados</p>
      </div>
     </div>
     <div class="dashboard-card">
      <div class="dashboard-icon">
       <svg width="32" height="32" viewbox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2"><circle cx="12" cy="12" r="10" /> <path d="M12 6v6l4 2" />
       </svg>
      </div>
      <div class="dashboard-content">
       <h3 id="pending-reports">0</h3>
       <p>Reports Pendentes</p>
      </div>
     </div>
     <div class="dashboard-card">
      <div class="dashboard-icon">
       <svg width="32" height="32" viewbox="0 0 24 24" fill="none" stroke="#8b5cf6" stroke-width="2"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" />
       </svg>
      </div>
      <div class="dashboard-content">
       <h3 id="total-km">0</h3>
       <p>Total KM Rodados</p>
      </div>
     </div>
     <div class="dashboard-card">
      <div class="dashboard-icon">
       <svg width="32" height="32" viewbox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" />
       </svg>
      </div>
      <div class="dashboard-content">
       <h3 id="active-drivers">0</h3>
       <p>Condutores Ativos</p>
      </div>
     </div>
     <div class="dashboard-card">
      <div class="dashboard-icon">
       <svg width="32" height="32" viewbox="0 0 24 24" fill="none" stroke="#06b6d4" stroke-width="2"><path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z" /> <polyline points="3.27,6.96 12,12.01 20.73,6.96" /> <line x1="12" y1="22.08" x2="12" y2="12" />
       </svg>
      </div>
      <div class="dashboard-content">
       <h3 id="avg-km-per-report">0</h3>
       <p>Média KM/Report</p>
      </div>
     </div>
     <div class="dashboard-card">
      <div class="dashboard-icon">
       <svg width="32" height="32" viewbox="0 0 24 24" fill="none" stroke="#84cc16" stroke-width="2"><polyline points="22,12 18,12 15,21 9,3 6,12 2,12" />
       </svg>
      </div>
      <div class="dashboard-content">
       <h3 id="efficiency-rate">0%</h3>
       <p>Taxa de Eficiência</p>
      </div>
     </div>
     <div class="dashboard-card">
      <div class="dashboard-icon">
       <svg width="32" height="32" viewbox="0 0 24 24" fill="none" stroke="#f97316" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" /> <line x1="16" y1="2" x2="16" y2="6" /> <line x1="8" y1="2" x2="8" y2="6" /> <line x1="3" y1="10" x2="21" y2="10" />
       </svg>
      </div>
      <div class="dashboard-content">
       <h3 id="reports-today">0</h3>
       <p>Reports Hoje</p>
      </div>
     </div>
    </div><div class="bi-analytics-section"><div class="card">
      <div class="analytics-header">
       <h2>
        <svg width="24" height="24" viewbox="0 0 24 24" fill="none" stroke="#253d70" stroke-width="2" style="vertical-align: middle; margin-right: 8px;"><line x1="18" y1="20" x2="18" y2="10" /> <line x1="12" y1="20" x2="12" y2="4" /> <line x1="6" y1="20" x2="6" y2="14" />
        </svg> Analytics &amp; Business Intelligence</h2>
       <div class="analytics-controls"><select id="analytics-period" class="filter-select"> <option value="7">Últimos 7 dias</option> <option value="30" selected>Últimos 30 dias</option> <option value="90">Últimos 90 dias</option> <option value="365">Último ano</option> <option value="all">Todo o período</option> </select> <button class="btn btn-primary" id="refresh-analytics-btn">
         <svg width="16" height="16" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23,4 23,10 17,10" /> <polyline points="1,20 1,14 7,14" /> <path d="M20.49,9A9,9,0,0,0,5.64,5.64L1,10m22,4L18.36,18.36A9,9,0,0,1,3.51,15" />
         </svg> Atualizar </button>
       </div>
      </div>
     </div><div class="charts-grid"><div class="card chart-card">
       <div class="chart-header">
        <h3>
         <svg width="20" height="20" viewbox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2" style="vertical-align: middle; margin-right: 6px;"><polyline points="23,6 13.5,15.5 8.5,10.5 1,18" /> <polyline points="17,6 23,6 23,12" />
         </svg> Balanço mensal</h3>
        <div class="chart-legend"><span class="legend-item"> <span class="legend-color" style="background: #10b981;"></span> Enviados </span> <span class="legend-item"> <span class="legend-color" style="background: #f59e0b;"></span> Pendentes </span>
        </div>
       </div>
       <div class="chart-container">
        <canvas id="reports-trend-chart"></canvas>
       </div>
      </div><div class="card chart-card">
       <div class="chart-header">
        <h3>
         <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2" style="vertical-align: middle; margin-right: 6px;">
  <path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path>
  <path d="M22 12A10 10 0 0 0 12 2v10z"></path>
</svg> Distribuição de KM por Condutor</h3>
        <div class="chart-info"><span id="km-chart-total">Total: 0 km</span>
        </div>
       </div>
       <div class="chart-container">
        <canvas id="km-distribution-chart"></canvas>
       </div>
      </div><div class="card chart-card">
       <div class="chart-header">
        <h3>
         <svg width="20" height="20" viewbox="0 0 24 24" fill="none" stroke="#8b5cf6" stroke-width="2" style="vertical-align: middle; margin-right: 6px;"><path d="M21.21 15.89A10 10 0 118 2.83" /> <path d="M22 12A10 10 0 0012 2v10z" />
         </svg> Status dos Reports</h3>
        <div class="chart-legend"><span class="legend-item"> <span class="legend-color" style="background: #10b981;"></span> Enviados </span> <span class="legend-item"> <span class="legend-color" style="background: #f59e0b;"></span> Pendentes </span>
        </div>
       </div>
       <div class="chart-container">
        <canvas id="status-pie-chart"></canvas>
       </div>
      </div><div class="card chart-card full-width">
       <div class="chart-header">
        <h3>
         <svg width="20" height="20" viewbox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2" style="vertical-align: middle; margin-right: 6px;"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" /> <line x1="16" y1="2" x2="16" y2="6" /> <line x1="8" y1="2" x2="8" y2="6" /> <line x1="3" y1="10" x2="21" y2="10" /> <path d="M8 14h.01M12 14h.01M16 14h.01M8 18h.01M12 18h.01M16 18h.01" />
         </svg> Mapa de Calor - Atividade Diária</h3>
        <div class="heatmap-legend"><span>Menos ativo</span>
         <div class="heatmap-scale">
          <div class="heatmap-cell level-0"></div>
          <div class="heatmap-cell level-1"></div>
          <div class="heatmap-cell level-2"></div>
          <div class="heatmap-cell level-3"></div>
          <div class="heatmap-cell level-4"></div>
         </div><span>Mais ativo</span>
        </div>
       </div>
       <div class="heatmap-container" id="activity-heatmap"></div>
      </div><div class="card chart-card">
       <div class="chart-header">
        <h3>
         <svg width="20" height="20" viewbox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2" style="vertical-align: middle; margin-right: 6px;"><polyline points="22,12 18,12 15,21 9,3 6,12 2,12" />
         </svg> Métricas de Performance</h3>
       </div>
       <div class="performance-metrics">
        <div class="metric-item">
         <div class="metric-icon">
          <svg width="24" height="24" viewbox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2"><path d="M6 9H4.5a2.5 2.5 0 010-5H6" /> <path d="M18 9h1.5a2.5 2.5 0 000-5H18" /> <path d="M4 22h16" /> <path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22" /> <path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22" /> <path d="M18 2H6v7a6 6 0 0012 0V2z" />
          </svg>
         </div>
         <div class="metric-content">
          <div class="metric-value" id="top-performer">
           -
          </div>
          <div class="metric-label">
           Top Performer
          </div>
         </div>
        </div>
        <div class="metric-item">
         <div class="metric-icon">
          <svg width="24" height="24" viewbox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10" /> <line x1="12" y1="20" x2="12" y2="4" /> <line x1="6" y1="20" x2="6" y2="14" />
          </svg>
         </div>
         <div class="metric-content">
          <div class="metric-value" id="avg-reports-per-driver">
           0
          </div>
          <div class="metric-label">
           Média Reports/Condutor
          </div>
         </div>
        </div>
        <div class="metric-item">
         <div class="metric-icon">
          <svg width="24" height="24" viewbox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2"><circle cx="12" cy="12" r="10" /> <path d="M16 12l-4-4-4 4" /> <path d="M12 16V8" />
          </svg>
         </div>
         <div class="metric-content">
          <div class="metric-value" id="completion-rate">
           0%
          </div>
          <div class="metric-label">
           Taxa de Conclusão
          </div>
         </div>
        </div>
        <div class="metric-item">
         <div class="metric-icon">
          <svg width="24" height="24" viewbox="0 0 24 24" fill="none" stroke="#8b5cf6" stroke-width="2"><polyline points="23,6 13.5,15.5 8.5,10.5 1,18" /> <polyline points="17,6 23,6 23,12" />
          </svg>
         </div>
         <div class="metric-content">
          <div class="metric-value" id="growth-rate">
           0%
          </div>
          <div class="metric-label">
           Crescimento Mensal
          </div>
         </div>
        </div>
       </div>
      </div><div class="card chart-card">
       <div class="chart-header">
        <h3>
         <svg width="20" height="20" viewbox="0 0 24 24" fill="none" stroke="#06b6d4" stroke-width="2" style="vertical-align: middle; margin-right: 6px;"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z" /> <circle cx="12" cy="10" r="3" />
         </svg> Análise por Lotação</h3>
       </div>
       <div class="location-analysis" id="location-analysis"></div>
      </div>
     </div><div class="card">
      <div class="table-header">
       <h2>
        <svg width="24" height="24" viewbox="0 0 24 24" fill="none" stroke="#253d70" stroke-width="2" style="vertical-align: middle; margin-right: 8px;"><circle cx="11" cy="11" r="8" /> <path d="M21 21l-4.35-4.35" /> <circle cx="11" cy="8" r="2" /> <path d="M11 10v6" />
        </svg> Análise Avançada</h2>
       <div class="advanced-controls"><button class="btn btn-secondary" id="predictive-analysis-btn">
         <svg width="16" height="16" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z" />
         </svg> Análise Preditiva </button> <button class="btn btn-primary" id="anomaly-detection-btn">
         <svg width="16" height="16" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10" /> <path d="M12 8v4M12 16h.01" />
         </svg> Detectar Anomalias </button>
       </div>
      </div><div class="insights-panel" id="insights-panel">
       <div class="insight-card">
        <div class="insight-icon">
         <svg width="32" height="32" viewbox="0 0 24 24" fill="none" stroke="#0ea5e9" stroke-width="2"><circle cx="12" cy="12" r="5" /> <line x1="12" y1="1" x2="12" y2="3" /> <line x1="12" y1="21" x2="12"y2="23" /> <line x1="4.22" y1="4.22" x2="5.64" y2="5.64" /> <line x1="18.36" y1="18.36" x2="19.78" y2="19.78" /> <line x1="1" y1="12" x2="3" y2="12" /> <line x1="21" y1="12" x2="23" y2="12" /> <line x1="4.22" y1="19.78" x2="5.64" y2="18.36" /> <line x1="18.36" y1="5.64" x2="19.78" y2="4.22" />
         </svg>
        </div>
        <div class="insight-content">
         <h4>Insights Automáticos</h4>
         <p>Análises serão exibidas aqui baseadas nos dados disponíveis.</p>
        </div>
       </div>
      </div>
     </div>
    </div>
<div class="card" style="grid-column: 1 / -1;">
       <div class="table-header">
         <h2 style="display: flex; align-items: center; gap: 10px;">
           <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2">
             <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
           </svg>
           Monitor de Manutenção Preventiva (Termômetro)
         </h2>
         <button class="btn btn-secondary" onclick="exportMaintenanceHTML()" style="background-color: #ef4444;">
  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7,10 12,15 17,10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
  Baixar Relatório HTML
</button>
       </div>
       
       <div style="display: grid; grid-template-columns: 100px 1fr 150px 150px 120px; gap: 1rem; padding: 10px; background: #f1f5f9; font-weight: bold; color: #475569; border-radius: 8px 8px 0 0; font-size: 0.85rem;">
         <div>Status</div>
         <div>Veículo / Unidade</div>
         <div>KM Atual</div>
         <div>Próx. Revisão</div>
         <div>Falta</div>
       </div>
       
       <div id="maintenance-list" style="max-height: 400px; overflow-y: auto;">
         </div>
     </div>
   </div><div class="card">
    <div class="table-header">
     <h2>Ranking de Condutores</h2>
     <div class="ranking-filters"><select id="ranking-filter" class="filter-select"> <option value="km">Por KM Rodados</option> <option value="reports">Por Número de Reports</option> <option value="efficiency">Por Eficiência</option> </select> <button class="btn btn-secondary" id="export-ranking-btn">
       <svg width="16" height="16" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3" />
       </svg> Exportar Ranking </button>
     </div>
    </div>
    <div class="ranking-container">
     <div class="ranking-item ranking-header">
      <div class="ranking-position">
       #
      </div>
      <div class="ranking-driver">
       Condutor
      </div>
      <div class="ranking-location">
       Lotação
      </div>
      <div class="ranking-metric">
       KM Total
      </div>
      <div class="ranking-reports">
       Reports
      </div>
      <div class="ranking-avg">
       Média KM/Report
      </div>
     </div>
     <div id="ranking-list"></div>
    </div>
   </div><div class="card">
    <div class="table-header">
     <h2>Relatórios Detalhados</h2>
     <div class="reports-controls">
      <div class="search-filters"><input type="text" id="search-driver" class="filter-select" placeholder="Buscar por condutor..."> <input type="text" id="search-plate" class="filter-select" placeholder="Buscar por placa..."> <input type="date" id="date-from" class="filter-select"> <input type="date" id="date-to" class="filter-select">
      </div>
      <div class="export-buttons"><button class="btn btn-primary" id="export-pdf-btn">
        <svg width="16" height="16" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z" /> <polyline points="14,2 14,8 20,8" /> <line x1="16" y1="13" x2="8" y2="13" /> <line x1="16" y1="17" x2="8" y2="17" /> <polyline points="10,9 9,9 8,9" />
        </svg> Exportar PDF </button> <button class="btn btn-secondary" id="export-excel-btn">
        <svg width="16" height="16" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z" /> <polyline points="14,2 14,8 20,8" /> <rect x="8" y="12" width="8" height="6" />
        </svg> Exportar Excel </button> <button class="btn btn-gps" id="backup-data-btn" style="background: #0ea5e9; color: white;">
        <svg width="16" height="16" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4" /> <polyline points="7,10 12,15 17,10" /> <line x1="12" y1="15" x2="12" y2="3" />
        </svg> Backup Dados </button> <button class="btn" id="storage-stats-btn" style="background: #8b5cf6; color: white;">
        <svg width="16" height="16" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2" />
        </svg> Estatísticas </button>
      </div>
     </div>
    </div>
   </div><div class="card">
    <div class="table-header">
     <h2>Todos os Reports</h2>
     <div class="table-filters"><select id="status-filter" class="filter-select"> <option value="all">Todos os Status</option> <option value="Enviado">Apenas Enviados</option> <option value="Pendente">Apenas Pendentes</option> </select> <select id="driver-filter" class="filter-select"> <option value="all">Todos os Condutores</option> </select>
     </div>
    </div>
    <div class="table-container">
     <table>
      <thead>
       <tr>
        <th>Condutor</th>
        <th>Placa</th>
        <th>Data</th>
        <th>Destino</th>
        <th>KM Inicial</th>
        <th>KM Final</th>
        <th>Distância</th>
        <th>Status</th>
        <th>Lotação</th>
        <th>Responsável</th>
        <th>Unidade</th>
       </tr>
      </thead>
      <tbody id="manager-records-tbody">
       <tr>
        <td colspan="11" class="empty-state">
         <svg viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
         </svg><p>Nenhum registro encontrado</p></td>
       </tr>
      </tbody>
     </table>
    </div>
   </div>
  </div><div id="main-screen" class="container hidden">
   <div class="header-with-weather">
    <div class="header-content">
     <h1 id="main-title" style="font-size: 2rem; font-weight: 700; margin: 0 0 0.5rem 0; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 1rem;">
      <svg class="logo-icon" xmlns="http://www.w3.org/2000/svg" height="40" width="40" viewbox="0 0 640 640" fill="white"><path d="M541.9 139.5C546.4 127.7 543.6 114.3 534.7 105.4C525.8 96.5 512.4 93.6 500.6 98.2L84.6 258.2C71.9 263 63.7 275.2 64 288.7C64.3 302.2 73.1 314.1 85.9 318.3L262.7 377.2L321.6 554C325.9 566.8 337.7 575.6 351.2 575.9C364.7 576.2 376.9 568 381.8 555.4L541.8 139.4z" />
      </svg> Controle de Tráfego Diário</h1>
     <p id="main-department" style="font-size: 1rem; opacity: 0.9; margin: 0;">COORDENAÇÃO DE SUPORTE E LOGÍSTICA - SEMCAS</p>
    </div><div class="weather-card">
     <div class="info-section">
      <div class="background-design">
       <div class="circle"></div>
       <div class="circle"></div>
       <div class="circle"></div>
      </div>
      <div class="left-side">
       <div class="location-name" id="weather-location">
        São Luís, MA
       </div>
       <div class="weather-info">
        <div>
         <svg width="45" height="45" viewbox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><circle cx="12" cy="12" r="5" /> <line x1="12" y1="1" x2="12" y2="3" /> <line x1="12" y1="21" x2="12" y2="23" /> <line x1="4.22" y1="4.22" x2="5.64" y2="5.64" /> <line x1="18.36" y1="18.36" x2="19.78" y2="19.78" /> <line x1="1" y1="12" x2="3" y2="12" /> <line x1="21" y1="12" x2="23" y2="12" /> <line x1="4.22" y1="19.78" x2="5.64" y2="18.36" /> <line x1="18.36" y1="5.64" x2="19.78" y2="4.22" />
         </svg>
        </div>
        <div><span class="temperature" id="current-temp">28</span> <span style="font-size: 14pt;">°C</span>
        </div>
       </div>
      </div>
      <div class="right-side">
       <div>
        <div class="hour" id="current-hour">
         --:--
        </div>
        <div class="date" id="current-date">
         -- --- ----
        </div>
       </div>
      </div>
     </div>
     <div class="days-section"><button> <span class="day">SEG</span>
       <div class="icon-weather-day">
        <svg width="14" height="14" viewbox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><circle cx="12" cy="12" r="4" />
        </svg>
       </div></button> <button> <span class="day">TER</span>
       <div class="icon-weather-day">
        <svg width="14" height="14" viewbox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><circle cx="12" cy="12" r="4" />
        </svg>
       </div></button> <button> <span class="day">QUA</span>
       <div class="icon-weather-day">
        <svg width="14" height="14" viewbox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><circle cx="12" cy="12" r="4" />
        </svg>
       </div></button> <button> <span class="day">QUI</span>
       <div class="icon-weather-day">
        <svg width="14" height="14" viewbox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><circle cx="12" cy="12" r="4" />
        </svg>
       </div></button> <button> <span class="day">SEX</span>
       <div class="icon-weather-day">
        <svg width="14" height="14" viewbox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><circle cx="12" cy="12" r="4" />
        </svg>
       </div></button>
     </div>
    </div>
   </div>
   <div class="card">
    <div class="user-info">
     <div class="user-details"><span>Condutor: <strong id="logged-user"></strong></span> <span class="location" id="user-location"></span>
     </div><button class="btn btn-logout" id="logout-btn">
      <svg width="16" height="16" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4M16 17l5-5-5-5M21 12H9" />
      </svg> Sair </button>
    </div><div id="sync-status" class="sync-status">
     <div class="gps-info">
      <div class="gps-indicator"></div>
      <div>
       <div class="gps-text">
        Sincronizando dados...
       </div>
       <div class="gps-details">
        Enviando registros offline para o servidor
       </div>
      </div>
     </div>
    </div><div id="manual-form-container">
     <form id="traffic-form">
      <div class="form-grid">
       <div class="form-group"><label for="condutor">Condutor</label> <input type="text" id="condutor" required disabled>
       </div>
       <div class="form-group"><label for="placa">Placa do Veículo</label> <input type="text" id="placa" required placeholder="ABC-1234">
       </div>
       <div class="form-group"><label for="data">Data</label> <input type="date" id="data" required>
       </div>
       <div class="form-group"><label for="destino">Destino</label> <input type="text" id="destino" required placeholder="Ex: Partida para a Beira Mar">
       </div>
       <div class="form-group"><label for="km-inicial">KM Inicial</label> <input type="number" id="km-inicial" required min="0" step="0.1"> <small>O KM Final será preenchido automaticamente pelo próximo registro</small>
       </div>
      </div>
      <div class="button-group"><button type="button" class="btn btn-primary" id="btn-send-direct">
        <svg width="20" height="20" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z" />
        </svg><span id="text-send-direct">Enviar Direto</span> </button> <button type="button" class="btn btn-secondary" id="btn-add-queue">
        <svg width="20" height="20" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14" />
        </svg><span id="text-add-queue">Adicionar ao Resumo</span> </button>
      </div>
     </form>
    </div>
   </div>
   <div class="card">
    <div class="table-header">
     <h2 id="table-title">Resumo de Reports</h2>
     <div class="table-actions"><button class="btn btn-primary" id="btn-send-selected" disabled>
       <svg width="20" height="20" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z" />
       </svg><span id="text-send-selected">Enviar Selecionados</span> </button> <button class="btn btn-danger" id="btn-clear-all">
       <svg width="20" height="20" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2" />
       </svg><span id="text-clear-all">Limpar Todos</span> </button>
     </div>
    </div>
    <div class="table-container">
     <table>
      <thead>
       <tr>
        <th class="checkbox-cell"><input type="checkbox" id="select-all"></th>
        <th>Condutor</th>
        <th>Placa</th>
        <th>Data</th>
        <th>Destino</th>
        <th>KM Inicial</th>
        <th>KM Final</th>
        <th>Distância</th>
        <th>Status</th>
        <th>Responsável</th>
       </tr>
      </thead>
      <tbody id="records-tbody">
       <tr>
        <td colspan="10" class="empty-state">
         <svg viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
         </svg><p>Nenhum registro na fila</p></td>
       </tr>
      </tbody>
     </table>
    </div>
   </div>
  </div>

<div id="drivers-details-modal" class="modal-overlay hidden">
   <div class="modal" style="max-width: 900px;">
    <div class="modal-header">
     <h3 class="modal-title">
       <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#253d70" stroke-width="2" style="vertical-align: middle; margin-right: 8px;">
         <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
         <circle cx="9" cy="7" r="4"></circle>
         <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
         <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
       </svg>
       Detalhes dos Condutores
     </h3>
     <p class="modal-subtitle">Gerenciamento da base de usuários cadastrados</p>
    </div>

    <div style="display: flex; justify-content: flex-end; gap: 10px; margin-bottom: 15px;">
      <button class="btn btn-secondary" id="btn-export-drivers-excel">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:5px"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14,2 14,8 20,8"/><rect x="8" y="12" width="8" height="6"/></svg>
        Excel
      </button>
      <button class="btn btn-primary" id="btn-export-drivers-html" style="background-color: #ef4444;">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:5px"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14,2 14,8 20,8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10,9 9,9 8,9"/></svg>
        Relatório HTML
      </button>
    </div>

    <div class="table-container" style="max-height: 400px; overflow-y: auto;">
      <table>
        <thead>
          <tr>
            <th>Nome / Email</th>
            <th>Lotação Cadastrada</th>
            <th>Última Placa</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="drivers-list-tbody">
          </tbody>
      </table>
    </div>

    <div class="button-group" style="margin-top: 1.5rem;">
      <button class="btn" onclick="document.getElementById('drivers-details-modal').classList.add('hidden')" style="background: #64748b; color: white;">
        Fechar
      </button>
    </div>
   </div>
  </div>

  <footer id="app-footer">
    <div class="footer-container">
      <div class="footer-left">
        <div class="dev-photo-container">
          <img id="developer-photo" src="https://i.ibb.co/23ns06cH/me.jpg" alt="Welligton Ferreira" class="dev-photo">
        </div>
        <div class="dev-info">
          <span class="dev-name">Desenvolvido por Welligton Ferreira</span>
          <span class="dev-role">Full-Stack e Arquiteto de Sistemas</span>
        </div>
      </div>
      
      <div class="footer-right">
        <span class="system-name">Sistema de Controle de Tráfego - SEMCAS</span>
        <div class="system-meta">
          <span>V<span id="system-version">1.0</span> (Estável)</span>
          <span>|</span>
          <span>© <span id="current-year">2025</span></span>
        </div>
      </div>
    </div>
  </footer>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>

  <script>
    // SUA CONFIGURAÇÃO DO FIREBASE
    const firebaseConfig = {
      apiKey: "AIzaSyCAnfRhjlnlk0z_IXbK5tQviynh5ZzgRmM",
      authDomain: "controle-de-trafego-2fbe3.firebaseapp.com",
      projectId: "controle-de-trafego-2fbe3",
      storageBucket: "controle-de-trafego-2fbe3.firebasestorage.app",
      messagingSenderId: "665507103572",
      appId: "1:665507103572:web:6910dc97830e64b2fcfec1",
      measurementId: "G-SFGRXTEP8E"
    };

    // Inicializar Firebase
    firebase.initializeApp(firebaseConfig);

    // Referências dos serviços do Firebase
    const db = firebase.firestore();
    const auth = firebase.auth();
    const storage = firebase.storage();

    // ----- CÓDIGO DO APLICATIVO -----
    
    const defaultConfig = {
      page_title: "Sistema de Controle de Tráfego",
      department_name: "COORDENAÇÃO DE SUPORTE E LOGÍSTICA - SEMCAS",
    };

    let allRecords = [];
    let isProcessing = false;
    let currentUser = null; // Objeto de usuário global
    let chartsInstances = {}; // Variável para os gráficos

    async function onConfigChange(config) {
      // (Esta função permanece a mesma)
    }

    function adjustColor(color, percent) {
      // (Esta função permanece a mesma)
    }

    function switchTab(tab) {
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      
      document.getElementById(tab + '-tab').classList.add('active');
      document.getElementById(tab + '-content').classList.add('active');
    }

    function showForgotPassword() {
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      
      document.getElementById('forgot-password-content').classList.add('active');
    }

    function backToLogin() {
      document.getElementById('forgot-password-form').reset();
      
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      
      document.getElementById('login-content').classList.add('active');
      document.getElementById('login-tab').classList.add('active');
    }

    function updateWeatherCard() {
      // (Esta função permanece a mesma)
      const hourEl = document.getElementById('current-hour');
      const dateEl = document.getElementById('current-date');
      const now = new Date();
      hourEl.textContent = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
      dateEl.textContent = now.toLocaleDateString('pt-BR', { day: '2-digit', month: 'short', year: 'numeric' });
    }

    async function initializeApp() {
      console.log('🚀 Inicializando Sistema de Controle de Tráfego...');
      
      setupEventListeners();// Fecha os parênteses aqui e põe ponto e vírgula
  
  // Coloca o código do ano na linha de baixo
  // Atualiza o ano no rodapé
  const yearElement = document.getElementById('current-year');
  if(yearElement) {
    yearElement.textContent = new Date().getFullYear();
  }
      updateWeatherCard();
      setInterval(updateWeatherCard, 60000);
await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

      // NOVO: Listener de Estado de Autenticação
      auth.onAuthStateChanged(async (user) => {
        if (user) {
          // Usuário está logado
          console.log('✅ Usuário logado:', user.uid);
          await loadUserDataAndRecords(user);
          
        } else {
          // Usuário está deslogado
          console.log('🔒 Usuário deslogado.');
          currentUser = null;
          allRecords = [];
          document.getElementById('main-screen').classList.add('hidden');
          document.getElementById('manager-screen').classList.add('hidden');
          document.getElementById('login-screen').classList.remove('hidden');
          switchTab('login');
        }
      });
    }
    
    // NOVA FUNÇÃO: Carrega os dados do usuário e os registros após o login
    async function loadUserDataAndRecords(firebaseUser) {
      try {
        // 1. Buscar perfil do usuário no Firestore
        const userDoc = await db.collection("users").doc(firebaseUser.uid).get();
        if (!userDoc.exists) {
          showToast('Perfil de usuário não encontrado', 'error');
          await auth.signOut();
          return;
        }

        const userData = userDoc.data();
        const displayName = userData.nickname || userData.name.split(' ')[0];
        
        currentUser = {
          uid: firebaseUser.uid,
          email: firebaseUser.email,
          name: userData.name,
          displayName: displayName,
          location: userData.location,
          type: userData.type || 'condutor',
          photoURL: userData.photoURL || null
        };
        
        // 2. Definir a consulta de registros
        let recordsQuery = db.collection("records").orderBy("created_at", "desc");
        
        // Otimização: Gestores carregam tudo, condutores carregam apenas os seus
        if (currentUser.type !== 'gestor') {
          recordsQuery = recordsQuery.where("user_uid", "==", currentUser.uid);
        }
        
        const recordsSnapshot = await recordsQuery.limit(50).get(); // Limitar carga inicial
                                    
        allRecords = recordsSnapshot.docs.map(doc => {
          const data = doc.data();
          
          if (data.data && data.data.toDate) {
            data.data = data.data.toDate().toISOString().split('T')[0];
          }
          if (data.created_at && data.created_at.toDate) {
            data.created_at = data.created_at.toDate().toISOString();
          }
          
          return {
            id: doc.id, // ID do documento do Firestore
            ...data
          };
        });
        
        console.log(`📂 Dados carregados do Firestore: ${allRecords.length} registros`);

        // 3. Configurar a UI com base no tipo de usuário
        document.getElementById('login-screen').classList.add('hidden');
        
        if (currentUser.type === 'gestor') {
          document.getElementById('manager-screen').classList.remove('hidden');
          document.getElementById('manager-user-name').innerHTML = `<strong>${currentUser.name}</strong>`;
          document.getElementById('manager-user-location').textContent = `Gestor - ${currentUser.location}`;
          
          if (currentUser.photoURL) {
            document.getElementById('manager-photo').innerHTML = `<img src="${currentUser.photoURL}" alt="Foto do Gestor" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
          }
          updateManagerDashboard(); // Função completa do gestor
          
        } else {
          document.getElementById('main-screen').classList.remove('hidden');
          document.getElementById('logged-user').textContent = currentUser.displayName;
          document.getElementById('user-location').textContent = `Lotação: ${currentUser.location}`;
          document.getElementById('condutor').value = currentUser.displayName;
          
          const today = new Date().toISOString().split('T')[0];
          document.getElementById('data').value = today;
          
          renderTable(); // Renderiza apenas os registros do condutor
          updateSelectAllCheckbox();
        }
        
        showToast(`Bem-vindo, ${currentUser.displayName}!`, 'success');

     } catch (error) {
        console.error("Erro ao carregar dados do usuário:", error);
        // Alteramos a mensagem para ser mais clara
        showToast("Erro de conexão ao buscar dados. Atualize a página.", "error");
        
        // COMENTAMOS ou REMOVEMOS a linha abaixo para o sistema não te deslogar à força
        // await auth.signOut(); 
        
        // Opcional: Se der erro, volta a tela de login visualmente mas mantém a sessão
        // document.getElementById('login-screen').classList.remove('hidden');
        // document.getElementById('manager-screen').classList.add('hidden');
      }
    }

    function setupEventListeners() {
      document.getElementById('login-form').addEventListener('submit', handleLogin);
      document.getElementById('register-form').addEventListener('submit', handleRegister);
      document.getElementById('forgot-password-form').addEventListener('submit', handleForgotPassword);
      document.getElementById('logout-btn').addEventListener('click', handleLogout);
      document.getElementById('manager-logout-btn').addEventListener('click', handleLogout);

      document.getElementById('btn-send-direct').addEventListener('click', handleSendDirect);
      document.getElementById('btn-add-queue').addEventListener('click', handleAddToQueue);
      document.getElementById('btn-send-selected').addEventListener('click', handleSendSelected);
      document.getElementById('btn-clear-all').addEventListener('click', handleClearAll);
      document.getElementById('select-all').addEventListener('change', handleSelectAll);

      document.getElementById('confirm-responsible-btn').addEventListener('click', confirmResponsible);
      document.getElementById('cancel-responsible-btn').addEventListener('click', hideResponsibleModal);

      document.getElementById('ranking-filter').addEventListener('change', updateRanking);
      document.getElementById('status-filter').addEventListener('change', filterManagerTable);
      document.getElementById('driver-filter').addEventListener('change', filterManagerTable);

      document.getElementById('upload-photo-btn').addEventListener('click', () => {
        document.getElementById('photo-input').click();
      });
      document.getElementById('photo-input').addEventListener('change', handlePhotoUpload);
      
      // Botões do painel do Gestor
      document.getElementById('refresh-analytics-btn').addEventListener('click', updateBIAnalytics);
      document.getElementById('export-ranking-btn').addEventListener('click', exportRanking);
      document.getElementById('export-pdf-btn').addEventListener('click', exportToPDF);
      document.getElementById('export-excel-btn').addEventListener('click', exportToExcel);
      document.getElementById('backup-data-btn').addEventListener('click', showBackupModal);
      document.getElementById('storage-stats-btn').addEventListener('click', showStorageStats);
      document.getElementById('predictive-analysis-btn').addEventListener('click', showPredictiveAnalysis);
      document.getElementById('anomaly-detection-btn').addEventListener('click', detectAnomalies);
      
      // Filtros de busca
      document.getElementById('search-driver').addEventListener('input', applySearchFilters);
      document.getElementById('search-plate').addEventListener('input', applySearchFilters);
      document.getElementById('date-from').addEventListener('change', applySearchFilters);
      document.getElementById('date-to').addEventListener('change', applySearchFilters);

      // --- CÓDIGO NOVO DOS CONDUTORES (AGORA DENTRO DA FUNÇÃO) ---
      
      // Clique no Card de Total de Condutores
      const driverCard = document.getElementById('card-registered-drivers');
      if(driverCard) {
        driverCard.addEventListener('click', showDriversDetails);
      }

      // Botões de Exportação do Modal de Condutores
      const btnDriversExcel = document.getElementById('btn-export-drivers-excel');
      if(btnDriversExcel) btnDriversExcel.addEventListener('click', exportDriversToExcel);

      const btnDriversHtml = document.getElementById('btn-export-drivers-html');
      if(btnDriversHtml) btnDriversHtml.addEventListener('click', exportDriversToHTML);
    }
    // --- FUNÇÕES DE AUTENTICAÇÃO ATUALIZADAS ---

    async function handleLogin(e) {
      e.preventDefault();
      const email = document.getElementById('username').value.trim(); 
      const password = document.getElementById('password').value;

      if (!email || !password) {
        showToast('Preencha e-mail e senha', 'error');
        return;
      }

      const btn = document.getElementById('login-btn');
      btn.disabled = true;
      btn.innerHTML = '<div class="spinner"></div> Entrando...';

      try {
        await auth.signInWithEmailAndPassword(email, password);
        // Sucesso! O listener 'onAuthStateChanged' cuidará do resto.
      } catch (error) {
        console.error("Erro no login:", error);
        showToast('E-mail ou senha incorretos', 'error');
        btn.disabled = false;
        btn.innerHTML = '<svg width="20" height="20" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h4a2 2 0 012 2v14a2 2 0 01-2 2h-4M10 17l5-5-5-5M21 12H9" /></svg><span id="login-button-text">Entrar</span>';
      }
    }

    async function handleRegister(e) {
      e.preventDefault();
      const name = document.getElementById('reg-name').value.trim();
      const email = document.getElementById('reg-email').value.trim(); 
      const nickname = document.getElementById('reg-nickname').value.trim();
      const location = document.getElementById('reg-location').value.trim();
      const password = document.getElementById('reg-password').value;
      const confirmPassword = document.getElementById('reg-password-confirm').value;

      if (!name || !email || !location || !password || !confirmPassword) {
        showToast('Preencha todos os campos obrigatórios', 'error');
        return;
      }
      if (password.length < 6) {
          showToast('A senha deve ter no mínimo 6 caracteres', 'error');
          return;
      }
      if (password !== confirmPassword) {
        showToast('As senhas não coincidem', 'error');
        return;
      }

      const btn = document.getElementById('register-btn');
      btn.disabled = true;
      btn.innerHTML = '<div class="spinner"></div> Cadastrando...';

      try {
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        const user = userCredential.user;
        const userType = (name.toLowerCase() === 'welligton luis') ? 'gestor' : 'condutor';

        await db.collection("users").doc(user.uid).set({
          name: name,
          email: email,
          nickname: nickname || name.split(' ')[0],
          location: location,
          type: userType,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        showToast('Cadastro realizado com sucesso! Faça login.', 'success');
        document.getElementById('register-form').reset();
        switchTab('login');

      } catch (error) {
        console.error("Erro no cadastro:", error);
        let msg = (error.code === 'auth/email-already-in-use') ? 'Este e-mail já está em uso' : 'Erro ao cadastrar';
        showToast(msg, 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<svg width="20" height="20" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2M12.5 7a4 4 0 11-8 0 4 4 0 018 0z" /></svg><span id="register-button-text">Cadastrar</span>';
      }
    }

    async function handleForgotPassword(e) {
      e.preventDefault();
      const email = document.getElementById('recovery-email').value.trim();
      if (!email) {
        showToast('Digite seu e-mail de cadastro', 'error');
        return;
      }
      
      const btn = document.getElementById('recovery-btn');
      btn.disabled = true;
      btn.innerHTML = '<div class="spinner"></div> Enviando...';

      try {
        await auth.sendPasswordResetEmail(email);
        showToast('Link de recuperação enviado para seu e-mail!', 'success');
        backToLogin();
      } catch (error) {
        console.error("Erro ao recuperar senha:", error);
        showToast('Erro ao enviar e-mail. Verifique o e-mail digitado.', 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<svg width="20" height="20" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><span id="recovery-button-text">Enviar Link</span>';
      }
    }

    async function handleLogout() {
      try {
        await auth.signOut();
        showToast('Logout realizado com sucesso', 'success');
      } catch (error) {
        console.error("Erro ao sair:", error);
        showToast('Erro ao tentar sair', 'error');
      }
    }

    // --- FUNÇÕES DE DADOS (FIRESTORE) ---

    async function addRecordToFirestore(recordData) {
      try {
        recordData.user_uid = currentUser.uid;
        recordData.created_at = firebase.firestore.FieldValue.serverTimestamp(); 
        recordData.data = firebase.firestore.Timestamp.fromDate(new Date(recordData.data));

        const docRef = await db.collection("records").add(recordData);
        
        const newRecord = { 
          ...recordData, 
          id: docRef.id, 
          created_at: new Date().toISOString(),
          data: recordData.data.toDate().toISOString().split('T')[0]
        }; 
        
        allRecords.unshift(newRecord); 
        return newRecord;
        
      } catch (error) {
        console.error("Erro ao salvar registro no Firestore: ", error);
        showToast("Erro ao salvar no servidor", "error");
        return null;
      }
    }

    function getFormData() {
      const condutor = document.getElementById('condutor').value.trim();
      const placa = document.getElementById('placa').value.trim().toUpperCase();
      const data = document.getElementById('data').value;
      const destino = document.getElementById('destino').value.trim();
      const kmInicial = parseFloat(document.getElementById('km-inicial').value);

      if (!condutor || !placa || !data || !destino || isNaN(kmInicial)) {
        showToast('Preencha todos os campos, incluindo KM Inicial', 'error');
        return null;
      }
      
      const lastRecord = allRecords
        .filter(r => r.condutor === condutor && r.placa === placa && r.km_final === null && r.status === 'Pendente' && r.user_uid === currentUser.uid)
        .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))[0];

      if (lastRecord) {
        if (kmInicial < lastRecord.km_inicial) {
           showToast('O novo KM Inicial não pode ser menor que o KM da rota anterior.', 'error');
           return null;
        }
        
        lastRecord.km_final = kmInicial;
        
        db.collection("records").doc(lastRecord.id).update({
          km_final: kmInicial
        }).catch(err => console.error("Erro ao atualizar km_final:", err));
      }

      return {
        condutor,
        placa,
        data, 
        destino,
        km_inicial: kmInicial,
        km_final: null, 
        status: 'Pendente',
        user_id: currentUser.name,
        user_location: currentUser.location,
        module_type: 'manual'
      };
    }

    function clearForm() {
      document.getElementById('destino').value = '';
      document.getElementById('km-inicial').value = '';
      document.getElementById('data').value = new Date().toISOString().split('T')[0];
      document.getElementById('destino').focus();
    }

    async function handleSendDirect() {
      if (isProcessing) return;

      let formData = getFormData();
      if (!formData) return;

      isProcessing = true;
      const btn = document.getElementById('btn-send-direct');
      const originalText = btn.innerHTML;
      btn.innerHTML = '<div class="spinner"></div> Enviando...';
      btn.disabled = true;

      formData.status = 'Enviado'; 
      
      const newRecord = await addRecordToFirestore(formData);
      
      if (newRecord) {
        renderTable();
        updateSelectAllCheckbox();
        if (currentUser && currentUser.type === 'gestor') {
          updateManagerDashboard();
        }
        showToast('Registro enviado com sucesso!', 'success');
        clearForm();
      } else {
        showToast('Erro ao enviar registro', 'error');
      }

      btn.innerHTML = originalText;
      btn.disabled = false;
      isProcessing = false;
    }

    async function handleAddToQueue() {
      if (isProcessing) return;

      const formData = getFormData();
      if (!formData) return;

      isProcessing = true;
      const btn = document.getElementById('btn-add-queue');
      const originalText = btn.innerHTML;
      btn.innerHTML = '<div class="spinner"></div> Adicionando...';
      btn.disabled = true;
      
      const newRecord = await addRecordToFirestore(formData);

      if (newRecord) {
        renderTable();
        updateSelectAllCheckbox();
        if (currentUser && currentUser.type === 'gestor') {
          updateManagerDashboard();
        }
        showToast('Adicionado ao resumo!', 'success');
        clearForm();
      } else {
        showToast('Erro ao adicionar registro', 'error');
      }

      btn.innerHTML = originalText;
      btn.disabled = false;
      isProcessing = false;
    }
    
    function handleSendSelected() {
      const checkboxes = document.querySelectorAll('.record-checkbox:checked:not(:disabled)');
      if (checkboxes.length === 0) {
        showToast('Nenhum registro selecionado', 'error');
        return;
      }
      showResponsibleModal(checkboxes);
    }

    async function handleClearAll() {
      if (isProcessing) return;

      const userPendingRecords = allRecords.filter(r => r.status === 'Pendente' && r.user_uid === currentUser.uid);
      if (userPendingRecords.length === 0) {
        showToast('Nenhum registro pendente para limpar', 'error');
        return;
      }

      isProcessing = true;
      const btn = document.getElementById('btn-clear-all');
      const originalText = btn.innerHTML;
      btn.innerHTML = '<div class="spinner"></div> Limpando...';
      btn.disabled = true;

      const batch = db.batch();
      userPendingRecords.forEach(record => {
        const docRef = db.collection("records").doc(record.id);
        batch.delete(docRef);
      });

      try {
        await batch.commit();
        allRecords = allRecords.filter(r => !(r.status === 'Pendente' && r.user_uid === currentUser.uid));
        renderTable();
        updateSelectAllCheckbox();
        
        if (currentUser && currentUser.type === 'gestor') {
          updateManagerDashboard();
        }
        showToast('Registros pendentes removidos!', 'success');
      } catch (error) {
        console.error("Erro ao limpar registros:", error);
        showToast('Erro ao limpar registros', 'error');
      }

      btn.innerHTML = originalText;
      btn.disabled = false;
      isProcessing = false;
    }

    function handleSelectAll(e) {
      const checkboxes = document.querySelectorAll('.record-checkbox:not(:disabled)');
      checkboxes.forEach(cb => {
        cb.checked = e.target.checked;
      });
      updateSendButton();
    }

    function updateSelectAllCheckbox() {
      const selectAll = document.getElementById('select-all');
      const userCheckboxes = document.querySelectorAll('.record-checkbox:not(:disabled)');
      const userCheckedBoxes = document.querySelectorAll('.record-checkbox:checked:not(:disabled)');
      
      if (userCheckboxes.length === 0) {
        selectAll.checked = false;
        selectAll.indeterminate = false;
      } else if (userCheckedBoxes.length === userCheckboxes.length) {
        selectAll.checked = true;
        selectAll.indeterminate = false;
      } else if (userCheckedBoxes.length > 0) {
        selectAll.checked = false;
        selectAll.indeterminate = true;
      } else {
        selectAll.checked = false;
        selectAll.indeterminate = false;
      }
    }

    function updateSendButton() {
      const checkedBoxes = document.querySelectorAll('.record-checkbox:checked:not(:disabled)');
      document.getElementById('btn-send-selected').disabled = checkedBoxes.length === 0;
      updateSelectAllCheckbox();
    }

    function renderTable() {
      const tbody = document.getElementById('records-tbody');
      const userRecords = allRecords.filter(record => record.user_uid === currentUser.uid);
      
      if (userRecords.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="10" class="empty-state">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
              </svg>
              <p>Nenhum registro na fila</p>
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = userRecords.map(record => {
        const kmFinal = record.km_final !== null ? record.km_final.toFixed(1) + ' km' : '<em style="color: #9ca3af;">Aguardando...</em>';
        const distancia = (record.km_final !== null && record.km_final > record.km_inicial) ? (record.km_final - record.km_inicial).toFixed(1) + ' km' : '<em style="color: #9ca3af;">-</em>';
        const statusClass = `status-${record.status.toLowerCase()}`;
        const isDisabled = record.status !== 'Pendente';
        
        let dataFormatada = 'Data Inválida';
        if (record.data) {
            const dateParts = record.data.split('-'); // [YYYY, MM, DD]
            if (dateParts.length === 3) {
              dataFormatada = `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}`;
            }
        }
        
        const responsavel = record.responsavel_unidade || '-';
        
        return `
          <tr>
            <td class="checkbox-cell">
              <input type="checkbox" 
                     class="record-checkbox" 
                     data-id="${record.id}"
                     ${isDisabled ? 'disabled' : ''}
                     onchange="updateSendButton()">
            </td>
            <td>${record.condutor}</td>
            <td>${record.placa}</td>
            <td>${dataFormatada}</td>
            <td>${record.destino}</td>
            <td>${record.km_inicial.toFixed(1)} km</td>
            <td>${kmFinal}</td>
            <td><strong>${distancia}</strong></td>
            <td><span class="status-badge ${statusClass}">${record.status}</span></td>
            <td><small>${responsavel}</small></td>
          </tr>
        `;
      }).join('');

      updateSendButton();
    }

    function showToast(message, type = 'success') {
      const existingToast = document.querySelector('.toast');
      if (existingToast) {
        existingToast.remove();
      }

      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      
      const icon = type === 'success' 
        ? '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>'
        : '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M15 9l-6 6M9 9l6 6"/></svg>';
      
      toast.innerHTML = `${icon}<span>${message}</span>`;
      document.body.appendChild(toast);

      setTimeout(() => {
        toast.remove();
      }, 3000);
    }
    
    // =================================================================
    //  FUNÇÕES DO POP-UP DE KM FINAL (JÁ INCLUÍDAS)
    // =================================================================

    function showResponsibleModal(checkboxes) {
      let selectedRecords = [];
      let intermediateRecords = [];
      let lastPendingRecord = null;
      let totalKm = 0;

      // 1. Filtrar todos os registros selecionados, pendentes e do usuário atual
      checkboxes.forEach(checkbox => {
        const recordId = checkbox.dataset.id;
        const record = allRecords.find(r => r.id === recordId);
        if (record && record.status === 'Pendente' && record.user_uid === currentUser.uid) {
          selectedRecords.push(record);
        }
      });

      if (selectedRecords.length === 0) {
        showToast('Nenhum registro pendente selecionado', 'error');
        return;
      }

      // 2. Separar os registros: O último (sem KM Final) e os intermediários (com KM Final)
      selectedRecords.forEach(record => {
        if (record.km_final === null) {
          if (lastPendingRecord !== null) {
            // Se já encontramos um registro sem KM final, não podemos ter dois.
            showToast('Erro: Você só pode fechar uma rota por vez.', 'error');
            return; // Aborta a função
          }
          lastPendingRecord = record;
        } else if (record.km_final > record.km_inicial) {
          intermediateRecords.push(record);
          totalKm += (record.km_final - record.km_inicial);
        }
      });
      
      const kmFinalGroup = document.getElementById('km-final-day-group');
      const kmFinalInput = document.getElementById('km-final-day');

      // 3. Se encontramos uma rota para fechar, mostre o campo de KM Final
      if (lastPendingRecord) {
        kmFinalGroup.style.display = 'block'; // Mostra o campo
        kmFinalInput.value = '';
        kmFinalInput.min = lastPendingRecord.km_inicial;
        kmFinalInput.placeholder = `KM deve ser > ${lastPendingRecord.km_inicial.toFixed(1)}`;
        
        window.lastRecordToUpdate = lastPendingRecord; 
        
      } else {
        kmFinalGroup.style.display = 'none'; // Esconde o campo
        kmFinalInput.value = '';
        window.lastRecordToUpdate = null;
      }
      
      // 4. Armazena TODOS os registros que serão enviados (intermediários + o último)
      window.selectedRecordsForSending = [...intermediateRecords, ...(lastPendingRecord ? [lastPendingRecord] : [])];
      
      if (window.selectedRecordsForSending.length === 0) {
        showToast('Nenhum registro válido para envio.', 'error');
        return;
      }

      // 5. Atualiza o resumo e mostra o modal
      document.getElementById('selected-count').textContent = window.selectedRecordsForSending.length;
      document.getElementById('selected-km').textContent = totalKm.toFixed(1) + ' km' + (lastPendingRecord ? ' (+ 1 pendente)' : '');
      document.getElementById('responsible-modal').classList.remove('hidden');
    }

    function hideResponsibleModal() {
      document.getElementById('responsible-modal').classList.add('hidden');
      document.getElementById('responsible-name').value = '';
      document.getElementById('unit-type').value = '';
      
      document.getElementById('km-final-day-group').style.display = 'none';
      document.getElementById('km-final-day').value = '';

      window.selectedRecordsForSending = null;
      window.lastRecordToUpdate = null;
    }

    async function confirmResponsible() {
      const responsibleName = document.getElementById('responsible-name').value.trim();
      const unitType = document.getElementById('unit-type').value;

      if (!responsibleName || !unitType) {
        showToast('Preencha o Nome do Responsável e o Tipo de Unidade', 'error');
        return;
      }

      if (!window.selectedRecordsForSending || window.selectedRecordsForSending.length === 0) {
        showToast('Nenhum registro selecionado', 'error');
        return;
      }

      // 1. Se tínhamos uma rota para fechar, validar o KM Final
      if (window.lastRecordToUpdate) {
        const kmFinalInput = document.getElementById('km-final-day');
        const newKmFinal = parseFloat(kmFinalInput.value);

        if (isNaN(newKmFinal) || newKmFinal <= 0) {
          showToast('Por favor, insira um KM Final válido.', 'error');
          kmFinalInput.focus();
          return;
        }

        if (newKmFinal < window.lastRecordToUpdate.km_inicial) {
          showToast(`O KM Final (${newKmFinal}) não pode ser menor que o KM Inicial (${window.lastRecordToUpdate.km_inicial}).`, 'error');
          kmFinalInput.focus();
          return;
        }

        window.lastRecordToUpdate.km_final = newKmFinal;
      }

      isProcessing = true;
      const btn = document.getElementById('confirm-responsible-btn');
      const originalText = btn.innerHTML;
      btn.innerHTML = '<div class="spinner"></div> Enviando...';
      btn.disabled = true;

      let successCount = 0;
      const batch = db.batch(); 

      for (const record of window.selectedRecordsForSending) {
        const recordRef = db.collection("records").doc(record.id);
        
        const dataToUpdate = {
          status: 'Enviado',
          responsavel_unidade: responsibleName,
          tipo_unidade: unitType
        };

        if (window.lastRecordToUpdate && record.id === window.lastRecordToUpdate.id) {
          dataToUpdate.km_final = record.km_final; 
        }

        batch.update(recordRef, dataToUpdate);

        const index = allRecords.findIndex(r => r.id === record.id);
        if (index !== -1) {
          allRecords[index].status = 'Enviado';
          allRecords[index].responsavel_unidade = responsibleName;
          allRecords[index].tipo_unidade = unitType;
          if (dataToUpdate.km_final) {
             allRecords[index].km_final = dataToUpdate.km_final;
          }
        }
        successCount++;
      }
      
      try {
        await batch.commit(); 
        
        renderTable(); 
        updateSelectAllCheckbox();
        
        if (currentUser && currentUser.type === 'gestor') {
          updateManagerDashboard();
        }

        if (successCount > 0) {
          showToast(`${successCount} registro(s) enviado(s) com sucesso!`, 'success');
        }
      } catch (error) {
          console.error("Erro ao enviar em lote:", error);
          showToast('Erro ao enviar registros. Tente novamente.', 'error');
      }

      btn.innerHTML = originalText;
      btn.disabled = false;
      isProcessing = false;
      
      hideResponsibleModal(); 
    }

    // --- FUNÇÕES DO DASHBOARD DO GESTOR (TODAS CORRIGIDAS) ---
    
    function updateManagerDashboard() {
      console.log('🔄 Atualizando dashboard do gestor...');
      updateDashboardStats(); 
      updateRanking(); 
      renderManagerTable(allRecords); 
      populateDriverFilter();
      updateBIAnalytics(); 
   updateMaintenanceMonitor(); 
fetchDriverStats();    
}

    function updateDashboardStats() {
      const totalReports = allRecords.length;
      const sentReports = allRecords.filter(r => r.status === 'Enviado').length;
      const pendingReports = allRecords.filter(r => r.status === 'Pendente').length;
      
      const totalKm = allRecords.reduce((sum, r) => {
        if (r.km_final !== null && r.km_final !== undefined && !isNaN(r.km_final) && r.km_final > r.km_inicial) {
          return sum + (r.km_final - r.km_inicial);
        }
        return sum;
      }, 0);

      const activeDrivers = new Set(allRecords.map(r => r.condutor)).size;
      const validReports = allRecords.filter(r => r.km_final !== null && r.km_final !== undefined && r.km_final > r.km_inicial).length;
      const avgKmPerReport = validReports > 0 ? (totalKm / validReports) : 0;
      const efficiencyRate = totalReports > 0 ? ((sentReports / totalReports) * 100) : 0;
      
      const today = new Date().toISOString().split('T')[0];
      const reportsToday = allRecords.filter(r => r.data === today).length;

      document.getElementById('total-reports').textContent = totalReports;
      document.getElementById('sent-reports').textContent = sentReports;
      document.getElementById('pending-reports').textContent = pendingReports;
      document.getElementById('total-km').textContent = totalKm.toFixed(1) + ' km';
      document.getElementById('active-drivers').textContent = activeDrivers;
      document.getElementById('avg-km-per-report').textContent = avgKmPerReport.toFixed(1) + ' km';
      document.getElementById('efficiency-rate').textContent = efficiencyRate.toFixed(1) + '%';
      document.getElementById('reports-today').textContent = reportsToday;
    }

    function updateBIAnalytics() {
      updatePerformanceMetrics();
      updateLocationAnalysis();
      generateActivityHeatmap();
      generateInsights();
      createCharts(); 
    }

// Função principal que gera o "Gráfico de Temperatura"
    function updateMaintenanceMonitor() {
      const container = document.getElementById('maintenance-list');
      if (!container) return;

      // 1. Agrupar por veículo para pegar o KM mais atual de cada um
      const vehicleMap = new Map();

      allRecords.forEach(r => {
        if (r.km_final && !isNaN(r.km_final)) {
          // Se o veículo já existe no mapa, só atualiza se o KM for maior
          if (!vehicleMap.has(r.placa) || r.km_final > vehicleMap.get(r.placa).km) {
            vehicleMap.set(r.placa, {
              placa: r.placa,
              km: r.km_final,
              unidade: r.tipo_unidade || r.user_location || 'Indefinido'
            });
          }
        }
      });

      // 2. Calcular previsões e temperatura
      let fleetStatus = Array.from(vehicleMap.values()).map(v => {
        // Lógica: Revisão a cada 10.000 km
        const intervaloRevisao = 10000;
        const proximaRevisao = Math.ceil((v.km + 1) / intervaloRevisao) * intervaloRevisao;
        const falta = proximaRevisao - v.km;
        const numRevisao = proximaRevisao / 10000;

        // Definir temperatura (cor e ícone)
        let statusColor, statusIcon, statusText, bgStyle;
        
        if (falta <= 1000) {
          statusColor = '#ef4444'; // Vermelho (Quente/Crítico)
          statusIcon = '🔥';
          statusText = 'Crítico';
          bgStyle = 'linear-gradient(90deg, rgba(239,68,68,0.1) 0%, rgba(255,255,255,0) 100%)';
        } else if (falta <= 3000) {
          statusColor = '#f59e0b'; // Amarelo (Morno/Atenção)
          statusIcon = '⚠️';
          statusText = 'Atenção';
          bgStyle = 'linear-gradient(90deg, rgba(245,158,11,0.1) 0%, rgba(255,255,255,0) 100%)';
        } else {
          statusColor = '#10b981'; // Verde/Azul (Frio/Seguro)
          statusIcon = '❄️';
          statusText = 'Seguro';
          bgStyle = 'transparent';
        }

        return { ...v, proximaRevisao, falta, numRevisao, statusColor, statusIcon, statusText, bgStyle };
      });

      // 3. Ordenar: Os mais "quentes" (menor KM faltando) aparecem primeiro
      fleetStatus.sort((a, b) => a.falta - b.falta);

      // 4. Renderizar na tela
      if (fleetStatus.length === 0) {
        container.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">Nenhum dado de veículo disponível.</div>';
        return;
      }

      container.innerHTML = fleetStatus.map(v => `
        <div style="display: grid; grid-template-columns: 100px 1fr 150px 150px 120px; gap: 1rem; padding: 12px 10px; border-bottom: 1px solid #eee; align-items: center; background: ${v.bgStyle};">
          
          <div style="color: ${v.statusColor}; font-weight: bold; font-size: 0.85rem; display: flex; align-items: center; gap: 5px;">
            <span>${v.statusIcon}</span> ${v.statusText}
          </div>

          <div style="display: flex; flex-direction: column;">
            <span style="font-weight: bold; color: #1e293b;">${v.placa}</span>
            <span style="font-size: 0.75rem; color: #64748b;">${v.unidade}</span>
          </div>

          <div style="font-family: monospace; font-size: 0.95rem; color: #334155;">
            ${v.km.toLocaleString('pt-BR')} km
          </div>

          <div>
            <span style="background: #e2e8f0; color: #253d70; padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: bold;">
              ${v.numRevisao}ª Revisão
            </span>
            <div style="font-size: 0.75rem; color: #64748b; margin-top: 2px;">aos ${v.proximaRevisao.toLocaleString()} km</div>
          </div>

          <div style="font-weight: bold; color: ${v.statusColor};">
            - ${v.falta.toLocaleString()} km
          </div>

        </div>
      `).join('');
    }

    // Função para Exportar Excel desta lista específica
    // Função NOVA para Exportar Relatório HTML Bonito
    function exportMaintenanceHTML() {
      // 1. Preparar os dados (Lógica idêntica ao monitor da tela)
      const vehicleMap = new Map();
      allRecords.forEach(r => {
        if (r.km_final && !isNaN(r.km_final)) {
          if (!vehicleMap.has(r.placa) || r.km_final > vehicleMap.get(r.placa).km) {
            vehicleMap.set(r.placa, { 
              placa: r.placa, 
              km: r.km_final, 
              unidade: r.tipo_unidade || r.user_location || 'Indefinido'
            });
          }
        }
      });

      // Calcular status e ordenar
      const fleetStatus = Array.from(vehicleMap.values()).map(v => {
        const proximaRevisao = Math.ceil((v.km + 1) / 10000) * 10000;
        const falta = proximaRevisao - v.km;
        const numRevisao = proximaRevisao / 10000;
        
        let statusConfig = {};
        
        if (falta <= 1000) {
          statusConfig = {
            text: 'CRÍTICO', icon: '🔥', color: '#b91c1c', bg: '#fecaca', labelClass: 'critico'
          };
        } else if (falta <= 3000) {
          statusConfig = {
            text: 'ATENÇÃO', icon: '⚠️', color: '#b45309', bg: '#fde68a', labelClass: 'atencao'
          };
        } else {
          statusConfig = {
            text: 'SEGURO', icon: '❄️', color: '#15803d', bg: '#dcfce7', labelClass: 'seguro'
          };
        }

        return { ...v, proximaRevisao, falta, numRevisao, statusConfig };
      }).sort((a, b) => a.falta - b.falta); // Ordenar por urgência

      // 2. Construir o HTML
      const logoSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 640 640" fill="#253d70"><path d="M541.9 139.5C546.4 127.7 543.6 114.3 534.7 105.4C525.8 96.5 512.4 93.6 500.6 98.2L84.6 258.2C71.9 263 63.7 275.2 64 288.7C64.3 302.2 73.1 314.1 85.9 318.3L262.7 377.2L321.6 554C325.9 566.8 337.7 575.6 351.2 575.9C364.7 576.2 376.9 568 381.8 555.4L541.8 139.4z"/></svg>`;

      const htmlContent = `
        <!DOCTYPE html>
        <html lang="pt-BR">
        <head>
          <meta charset="UTF-8">
          <title>Relatório de Manutenção Preventiva</title>
          <style>
            body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 40px; max-width: 1000px; margin: 0 auto; color: #333; background: #f8fafc; }
            .container { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
            
            .header { display: flex; align-items: center; gap: 20px; border-bottom: 2px solid #e2e8f0; padding-bottom: 20px; margin-bottom: 30px; }
            .title h1 { margin: 0; color: #1e293b; font-size: 24px; }
            .title p { margin: 5px 0 0; color: #64748b; font-size: 14px; }
            .meta { margin-left: auto; text-align: right; font-size: 12px; color: #94a3b8; }
            
            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
            thead { background: #1e293b; color: white; }
            th { padding: 15px; text-align: left; font-size: 13px; font-weight: 600; letter-spacing: 0.5px; }
            td { padding: 12px 15px; border-bottom: 1px solid #e2e8f0; font-size: 14px; vertical-align: middle; }
            tr:hover { background-color: #f8fafc; }
            
            /* Estilos de Status */
            .badge { padding: 6px 12px; border-radius: 20px; font-size: 11px; font-weight: bold; display: inline-flex; align-items: center; gap: 6px; text-transform: uppercase; }
            
            .critico { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }
            .atencao { background: #fef3c7; color: #92400e; border: 1px solid #fcd34d; }
            .seguro  { background: #dcfce7; color: #166534; border: 1px solid #86efac; }
            
            .km-cell { font-family: monospace; font-size: 14px; font-weight: 600; color: #334155; }
            .falta-cell { font-weight: bold; }
            
            @media print {
              body { background: white; padding: 0; }
              .container { box-shadow: none; padding: 0; }
            }
          </style>
        </head>
        <body>
          <div class="container">
            <div class="header">
              ${logoSvg}
              <div class="title">
                <h1>Monitor de Manutenção Preventiva</h1>
                <p>SEMCAS - Coordenação de Suporte e Logística</p>
              </div>
              <div class="meta">
                Gerado em: ${new Date().toLocaleDateString('pt-BR')} às ${new Date().toLocaleTimeString('pt-BR')}
              </div>
            </div>

            <table>
              <thead>
                <tr>
                  <th>STATUS</th>
                  <th>PLACA / UNIDADE</th>
                  <th>KM ATUAL</th>
                  <th>PRÓXIMA REVISÃO</th>
                  <th>FALTA (KM)</th>
                </tr>
              </thead>
              <tbody>
                ${fleetStatus.map(v => `
                  <tr style="${v.statusConfig.text === 'CRÍTICO' ? 'background-color: #fff1f2;' : ''}">
                    <td>
                      <span class="badge ${v.statusConfig.labelClass}">
                        ${v.statusConfig.icon} ${v.statusConfig.text}
                      </span>
                    </td>
                    <td>
                      <div style="font-weight: bold; color: #1e293b;">${v.placa}</div>
                      <div style="font-size: 12px; color: #64748b;">${v.unidade}</div>
                    </td>
                    <td class="km-cell">${v.km.toLocaleString('pt-BR')} km</td>
                    <td>
                      <div style="font-weight: 600; color: #334155;">${v.numRevisao}ª Revisão</div>
                      <div style="font-size: 11px; color: #64748b;">aos ${v.proximaRevisao.toLocaleString('pt-BR')} km</div>
                    </td>
                    <td class="falta-cell" style="color: ${v.statusConfig.color}">
                      ${v.falta.toLocaleString('pt-BR')} km
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
            
            <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee; text-align: center; color: #94a3b8; font-size: 12px;">
              <p>Este relatório auxilia no controle de frota e deve ser usado como referência para agendamento de manutenções.</p>
            </div>
          </div>
        </body>
        </html>
      `;

      // 3. Gerar e baixar o arquivo
      const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `Relatorio_Manutencao_${new Date().toISOString().split('T')[0]}.html`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
      
      showToast('Relatório HTML gerado com sucesso!', 'success');
    }
    function updatePerformanceMetrics() {
       const driverStats = {};
      
      allRecords.forEach(record => {
        const driver = record.condutor;
        if (!driverStats[driver]) {
          driverStats[driver] = {
            name: driver,
            totalKm: 0,
            reportCount: 0,
            sentReports: 0
          };
        }
        
        if (record.km_final !== null && record.km_final > record.km_inicial) {
          driverStats[driver].totalKm += (record.km_final - record.km_inicial);
        }
        driverStats[driver].reportCount++;
        if (record.status === 'Enviado') {
          driverStats[driver].sentReports++;
        }
      });

      const drivers = Object.values(driverStats);
      const topPerformer = drivers.length > 0 ? 
        drivers.reduce((max, driver) => driver.totalKm > max.totalKm ? driver : max) : { name: '-', totalKm: 0 };
      
      const avgReportsPerDriver = drivers.length > 0 ? 
        (allRecords.length / drivers.length) : 0;
      
      const completionRate = allRecords.length > 0 ? 
        ((allRecords.filter(r => r.status === 'Enviado').length / allRecords.length) * 100) : 0;

      const currentMonth = new Date().getMonth();
      const lastMonth = currentMonth === 0 ? 11 : currentMonth - 1;
      const currentMonthReports = allRecords.filter(r => new Date(r.data).getMonth() === currentMonth).length;
      const lastMonthReports = allRecords.filter(r => new Date(r.data).getMonth() === lastMonth).length;
      
      const growthRate = lastMonthReports > 0 ? 
        (((currentMonthReports - lastMonthReports) / lastMonthReports) * 100) : 0;

      document.getElementById('top-performer').textContent = topPerformer.name.split(' ')[0];
      document.getElementById('avg-reports-per-driver').textContent = avgReportsPerDriver.toFixed(1);
      document.getElementById('completion-rate').textContent = completionRate.toFixed(1) + '%';
      document.getElementById('growth-rate').textContent = (growthRate >= 0 ? '+' : '') + growthRate.toFixed(1) + '%';
    }

    function updateLocationAnalysis() {
      const locationStats = {};
      
      allRecords.forEach(record => {
        const location = record.user_location || "Indefinido";
        if (!locationStats[location]) {
          locationStats[location] = {
            name: location,
            reports: 0,
            totalKm: 0,
            drivers: new Set()
          };
        }
        
        locationStats[location].reports++;
        locationStats[location].drivers.add(record.condutor);
        if (record.km_final !== null && record.km_final > record.km_inicial) {
          locationStats[location].totalKm += (record.km_final - record.km_inicial);
        }
      });

      const container = document.getElementById('location-analysis');
      const locations = Object.values(locationStats).sort((a, b) => b.reports - a.reports);

      if (locations.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #64748b;">Nenhum dado disponível</p>';
        return;
      }
      container.innerHTML = locations.map(loc => `
        <div class="location-item">
          <span class="location-name">${loc.name}</span>
          <div class="location-stats">
            <div class="location-stat">
              <span class="location-stat-value">${loc.reports}</span>
              <span style="font-size: 0.7rem;">Reports</span>
            </div>
            <div class="location-stat">
              <span class="location-stat-value">${loc.totalKm.toFixed(0)} km</span>
              <span style="font-size: 0.7rem;">Total KM</span>
            </div>
            <div class="location-stat">
              <span class="location-stat-value">${loc.drivers.size}</span>
              <span style="font-size: 0.7rem;">Condutores</span>
            </div>
          </div>
        </div>
      `).join('');
    }

    function generateActivityHeatmap() {
      const container = document.getElementById('activity-heatmap');
      container.innerHTML = '<p style="text-align: center; color: #9ca3af; font-size: 0.8rem;">Mapa de calor em desenvolvimento.</p>';
    }

    function generateInsights() {
      // (Esta função pode ser implementada no futuro)
    }
// --- COLE ESTE BLOCO PARA CORRIGIR OS GRÁFICOS ---

    function createCharts() {
      // Esta é a função "gerente" que chama todos os gráficos
      try {
        if (typeof createTrendChart === 'function') createTrendChart();
        if (typeof createKMDistributionChart === 'function') createKMDistributionChart();
        if (typeof createStatusPieChart === 'function') createStatusPieChart();
      } catch (e) {
        console.error("Erro ao renderizar gráficos:", e);
      }
    }

    function createTrendChart() {
      const canvas = document.getElementById('reports-trend-chart');
      if (!canvas) return;
      
      const ctx = canvas.getContext('2d');

      // Destruir gráfico anterior se existir
      if (chartsInstances['reports-trend-chart']) {
        chartsInstances['reports-trend-chart'].destroy();
      }

      // 1. Filtrar dados APENAS do Mês Atual
      const now = new Date();
      const currentMonth = now.getMonth(); 
      const currentYear = now.getFullYear();

      let sentCount = 0;
      let pendingCount = 0;

      allRecords.forEach(record => {
        let recDate = new Date();
        // Correção segura para datas
        if (record.data && typeof record.data === 'string') {
            const parts = record.data.split('-');
            if(parts.length === 3) {
                recDate = new Date(parts[0], parts[1] - 1, parts[2]);
            }
        }

        if (recDate.getMonth() === currentMonth && recDate.getFullYear() === currentYear) {
          if (record.status === 'Enviado') {
            sentCount++;
          } else if (record.status === 'Pendente') {
            pendingCount++;
          }
        }
      });

      // 2. Configuração do Gráfico de Rosca (Pizza)
      const config = {
        type: 'doughnut',
        data: {
          labels: ['Enviados', 'Pendentes'],
          datasets: [
            {
              label: 'Total',
              data: [sentCount, pendingCount],
              backgroundColor: ['#10b981', '#f59e0b'],
              hoverOffset: 4,
              borderWidth: 0
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top',
              labels: { usePointStyle: true, padding: 15 }
            },
            title: {
              display: true,
              text: 'Balanço de ' + now.toLocaleString('pt-BR', { month: 'long' }),
              font: { size: 14 },
              padding: { bottom: 10 }
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        const label = context.label || '';
                        const value = context.raw || 0;
                        const total = sentCount + pendingCount;
                        const percentage = total > 0 ? Math.round((value / total) * 100) + '%' : '0%';
                        return ` ${label}: ${value} (${percentage})`;
                    }
                }
            }
          },
          cutout: '65%', 
        },
      };

      chartsInstances['reports-trend-chart'] = new Chart(ctx, config);
    }


    function createKMDistributionChart() {
      const driverKm = {};
      allRecords.forEach(r => {
        if (r.km_final !== null && r.km_final > r.km_inicial) {
          const driver = r.condutor;
          const dist = r.km_final - r.km_inicial;
          driverKm[driver] = (driverKm[driver] || 0) + dist;
        }
      });

      const sortedDrivers = Object.entries(driverKm)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10); 

      const labels = sortedDrivers.map(d => d[0].split(' ')[0]); 
      const data = sortedDrivers.map(d => d[1].toFixed(1)); 

      const ctx = document.getElementById('km-distribution-chart').getContext('2d');
      if (chartsInstances['km-distribution-chart']) {
        chartsInstances['km-distribution-chart'].destroy();
      }
      chartsInstances['km-distribution-chart'] = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'KM Rodado',
            data: data,
            backgroundColor: '#3b82f6'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true } }
        }
      });
      
      const totalKm = data.reduce((a, b) => a + parseFloat(b), 0);
      document.getElementById('km-chart-total').textContent = `Total: ${totalKm.toFixed(1)} km`;
    }

    function createStatusPieChart() {
      const sent = allRecords.filter(r => r.status === 'Enviado').length;
      const pending = allRecords.filter(r => r.status === 'Pendente').length;

      const ctx = document.getElementById('status-pie-chart').getContext('2d');
      if (chartsInstances['status-pie-chart']) {
        chartsInstances['status-pie-chart'].destroy();
      }
      chartsInstances['status-pie-chart'] = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Enviados', 'Pendentes'],
          datasets: [{
            data: [sent, pending],
            backgroundColor: ['#10b981', '#f59e0b']
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom'
            }
          }
        }
      });
    }

    function updateRanking() {
      const driverStats = {};
      allRecords.forEach(record => {
        const driver = record.condutor;
        if (!driverStats[driver]) {
          driverStats[driver] = {
            name: driver,
            location: record.user_location || 'N/A',
            totalKm: 0,
            reportCount: 0,
            validKmReports: 0
          };
        }
        
        if (record.km_final !== null && record.km_final > record.km_inicial) {
          driverStats[driver].totalKm += (record.km_final - record.km_inicial);
          driverStats[driver].validKmReports++;
        }
        driverStats[driver].reportCount++;
      });
      
      let drivers = Object.values(driverStats);
      drivers.forEach(driver => {
         driver.efficiency = driver.validKmReports > 0 ? (driver.totalKm / driver.validKmReports) : 0;
      });

      const filterType = document.getElementById('ranking-filter').value;
      
      if (filterType === 'km') {
        drivers.sort((a, b) => b.totalKm - a.totalKm);
      } else if (filterType === 'reports') {
        drivers.sort((a, b) => b.reportCount - a.reportCount);
      } else if (filterType === 'efficiency') {
         drivers.sort((a, b) => b.efficiency - a.efficiency);
      }
      
      renderRanking(drivers.slice(0, 10), filterType); 
    }

    function renderRanking(drivers, filterType) {
      const tbody = document.getElementById('ranking-list');
      if (drivers.length === 0) {
        tbody.innerHTML = '<div class="empty-ranking">Nenhum condutor encontrado</div>';
        return;
      }
      
      const headerMetric = document.querySelector('.ranking-header .ranking-metric');
      const headerAvg = document.querySelector('.ranking-header .ranking-avg');
      
      if(filterType === 'km') {
        headerMetric.textContent = 'KM Total';
        headerAvg.textContent = 'Média KM/Report';
      } else if (filterType === 'reports') {
        headerMetric.textContent = 'Reports';
        headerAvg.textContent = 'Média KM/Report';
      } else if (filterType === 'efficiency') {
        headerMetric.textContent = 'Média KM/Report';
        headerAvg.textContent = 'KM Total';
      }
      
      tbody.innerHTML = drivers.map((driver, index) => {
        const position = index + 1;
        let posClass = '';
        if (position === 1) posClass = 'gold';
        if (position === 2) posClass = 'silver';
        if (position === 3) posClass = 'bronze';
        
        const avgKm = driver.reportCount > 0 ? (driver.totalKm / driver.validKmReports) : 0;
        
        let metricValue, avgValue;
        
        if(filterType === 'km') {
          metricValue = `${driver.totalKm.toFixed(1)} km`;
          avgValue = `${avgKm.toFixed(1)} km`;
        } else if (filterType === 'reports') {
          metricValue = `${driver.reportCount} reports`;
          avgValue = `${avgKm.toFixed(1)} km`;
        } else if (filterType === 'efficiency') {
          metricValue = `${driver.efficiency.toFixed(1)} km`;
          avgValue = `${driver.totalKm.toFixed(1)} km`;
        }
        
        return `
          <div class="ranking-item">
            <div class="ranking-position ${posClass}">${position}</div>
            <div class="ranking-driver">${driver.name}</div>
            <div class="ranking-location">${driver.location}</div>
            <div class="ranking-metric">${metricValue}</div>
            <div class="ranking-reports">${driver.reportCount}</div>
            <div class="ranking-avg">${avgValue}</div>
          </div>
        `;
      }).join('');
    }

    function getFilteredRecords() {
      const statusFilter = document.getElementById('status-filter').value;
      const driverFilter = document.getElementById('driver-filter').value;
      const searchDriver = document.getElementById('search-driver').value.toLowerCase();
      const searchPlate = document.getElementById('search-plate').value.toLowerCase();
      const dateFrom = document.getElementById('date-from').value;
      const dateTo = document.getElementById('date-to').value;

      let filteredRecords = allRecords;

      if (statusFilter !== 'all') {
        filteredRecords = filteredRecords.filter(r => r.status === statusFilter);
      }
      if (driverFilter !== 'all') {
        filteredRecords = filteredRecords.filter(r => r.condutor === driverFilter);
      }
      if (searchDriver) {
        filteredRecords = filteredRecords.filter(r => r.condutor.toLowerCase().includes(searchDriver));
      }
      if (searchPlate) {
        filteredRecords = filteredRecords.filter(r => r.placa.toLowerCase().includes(searchPlate));
      }
      if (dateFrom) {
        filteredRecords = filteredRecords.filter(r => r.data >= dateFrom);
      }
      if (dateTo) {
        filteredRecords = filteredRecords.filter(r => r.data <= dateTo);
      }
      
      return filteredRecords;
    }
    
    function applySearchFilters() {
      const filteredRecords = getFilteredRecords();
      renderManagerTable(filteredRecords);
    }

    function filterManagerTable() {
      applySearchFilters();
    }

    function renderManagerTable(records) {
      const tbody = document.getElementById('manager-records-tbody');
      
      if (records.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="11" class="empty-state">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
              </svg>
              <p>Nenhum registro encontrado para os filtros atuais</p>
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = records.map(record => {
        const kmFinal = record.km_final !== null ? record.km_final.toFixed(1) + ' km' : '<em style="color: #9ca3af;">Aguardando...</em>';
        const distancia = (record.km_final !== null && record.km_final > record.km_inicial) ? (record.km_final - record.km_inicial).toFixed(1) + ' km' : '<em style="color: #9ca3af;">-</em>';
        const statusClass = `status-${record.status.toLowerCase()}`;
        
        let dataFormatada = 'Data Inválida';
        if (record.data) {
            const dateParts = record.data.split('-');
            if (dateParts.length === 3) {
              dataFormatada = `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}`;
            }
        }
        
        const responsavel = record.responsavel_unidade || '-';
        const tipoUnidade = record.tipo_unidade || '-';
        
        return `
          <tr>
            <td>${record.condutor}</td>
            <td>${record.placa}</td>
            <td>${dataFormatada}</td>
            <td>${record.destino}</td>
            <td>${record.km_inicial.toFixed(1)} km</td>
            <td>${kmFinal}</td>
            <td><strong>${distancia}</strong></td>
            <td><span class="status-badge ${statusClass}">${record.status}</span></td>
            <td>${record.user_location}</td>
            <td><small>${responsavel}</small></td>
            <td><small>${tipoUnidade}</small></td>
          </tr>
        `;
      }).join('');
    }

    function populateDriverFilter() {
      const drivers = [...new Set(allRecords.map(r => r.condutor))].sort();
      const select = document.getElementById('driver-filter');
      
      const firstOption = select.options[0];
      select.innerHTML = '';
      select.appendChild(firstOption);
      
      drivers.forEach(driver => {
        const option = document.createElement('option');
        option.value = driver;
        option.textContent = driver;
        select.appendChild(option);
      });
    }

    function handlePhotoUpload(e) {
      const file = e.target.files[0];
      if (!file) return;

      if (file.size > 2 * 1024 * 1024) {
        showToast('A imagem deve ter no máximo 2MB', 'error');
        return;
      }
      if (!file.type.startsWith('image/')) {
        showToast('Apenas arquivos de imagem são permitidos', 'error');
        return;
      }

      const storageRef = storage.ref(`manager_photos/${currentUser.uid}/profile.jpg`);
      const uploadTask = storageRef.put(file);

      uploadTask.on('state_changed', 
        (snapshot) => {
          const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
          showToast(`Enviando foto... ${Math.round(progress)}%`, 'success');
        }, 
        (error) => {
          console.error("Erro no upload: ", error);
          showToast("Erro ao enviar foto", "error");
        }, 
        () => {
          uploadTask.snapshot.ref.getDownloadURL().then(async (downloadURL) => {
            console.log('Arquivo disponível em', downloadURL);
            
            document.getElementById('manager-photo').innerHTML = `<img src="${downloadURL}" alt="Foto do Gestor" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
            
            try {
              await db.collection("users").doc(currentUser.uid).update({
                photoURL: downloadURL
              });
              currentUser.photoURL = downloadURL; 
              showToast('Foto do perfil atualizada!', 'success');
            } catch (error) {
              console.error("Erro ao salvar URL da foto: ", error);
            }
          });
        }
      );
    }
    
    function exportRanking() {
      showToast('Função de Exportar Ranking em desenvolvimento.', 'success');
    }

    // Função atualizada: Gera e baixa um arquivo .html completo com logo e tabela
    function exportToPDF() {
      const records = getFilteredRecords(); // Usa os filtros atuais da tabela
      
      if (records.length === 0) {
        showToast('Nenhum dado para gerar relatório', 'error');
        return;
      }

      showToast('Gerando arquivo do relatório...', 'success');

      // Cálculos para o cabeçalho do relatório
      const totalReports = records.length;
      const sentReports = records.filter(r => r.status === 'Enviado').length;
      const pendingReports = records.filter(r => r.status === 'Pendente').length;
      const totalKm = records.reduce((sum, r) => {
        if (r.km_final !== null && r.km_final !== undefined && !isNaN(r.km_final) && r.km_final > r.km_inicial) {
          return sum + (r.km_final - r.km_inicial);
        }
        return sum;
      }, 0);

      // Helper para formatar data
      const formatDate = (dateStr) => {
        if (!dateStr) return '-';
        const date = new Date(dateStr);
        date.setDate(date.getDate() + 1); // Ajuste de fuso
        return date.toLocaleDateString('pt-BR');
      };

      // A Logo SVG do seu sistema (para embutir no relatório)
      const logoSvg = `
        <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 640 640" fill="#253d70">
          <path d="M541.9 139.5C546.4 127.7 543.6 114.3 534.7 105.4C525.8 96.5 512.4 93.6 500.6 98.2L84.6 258.2C71.9 263 63.7 275.2 64 288.7C64.3 302.2 73.1 314.1 85.9 318.3L262.7 377.2L321.6 554C325.9 566.8 337.7 575.6 351.2 575.9C364.7 576.2 376.9 568 381.8 555.4L541.8 139.4z"/>
        </svg>
      `;

      // Conteúdo HTML do Relatório
      const htmlContent = `
        <!DOCTYPE html>
        <html lang="pt-BR">
        <head>
          <meta charset="UTF-8">
          <title>Relatório de Tráfego - SEMCAS</title>
          <style>
            body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color: #333; line-height: 1.6; padding: 40px; max-width: 1200px; margin: 0 auto; background: #f9f9f9; }
            .report-container { background: white; padding: 40px; border-radius: 8px; box-shadow: 0 2px 15px rgba(0,0,0,0.05); }
            
            /* Cabeçalho */
            .header { display: flex; align-items: center; border-bottom: 2px solid #253d70; padding-bottom: 20px; margin-bottom: 30px; }
            .logo { margin-right: 20px; }
            .title-group h1 { margin: 0; color: #253d70; font-size: 24px; text-transform: uppercase; }
            .title-group p { margin: 5px 0 0; color: #666; font-size: 14px; }
            .meta-info { margin-left: auto; text-align: right; font-size: 12px; color: #888; }

            /* Resumo em Cards */
            .summary { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 30px; }
            .card { background: #f8fafc; padding: 15px; border-radius: 6px; border-left: 4px solid #253d70; text-align: center; }
            .card h3 { margin: 0; font-size: 24px; color: #253d70; }
            .card p { margin: 5px 0 0; font-size: 12px; color: #64748b; text-transform: uppercase; font-weight: 600; }
            
            /* Tabela */
            table { width: 100%; border-collapse: collapse; font-size: 12px; }
            thead { background: #253d70; color: white; }
            th { padding: 12px; text-align: left; font-weight: 600; letter-spacing: 0.5px; }
            td { padding: 10px 12px; border-bottom: 1px solid #eee; color: #444; }
            tr:nth-child(even) { background-color: #f8faff; }
            tr:hover { background-color: #f1f5f9; }
            
            /* Badges de Status */
            .badge { padding: 3px 8px; border-radius: 12px; font-size: 10px; font-weight: bold; display: inline-block; }
            .enviado { background: #d1fae5; color: #065f46; }
            .pendente { background: #fef3c7; color: #92400e; }
            
            /* Footer */
            .footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #eee; text-align: center; font-size: 11px; color: #999; }
            
            /* Estilo para Impressão real (caso abram o HTML e imprimam) */
            @media print {
              body { background: white; padding: 0; }
              .report-container { box-shadow: none; padding: 0; }
              .card { border: 1px solid #ddd; }
            }
          </style>
        </head>
        <body>
          <div class="report-container">
            <header class="header">
              <div class="logo">${logoSvg}</div>
              <div class="title-group">
                <h1>Relatório de Tráfego</h1>
                <p>COORDENAÇÃO DE SUPORTE E LOGÍSTICA - SEMCAS</p>
              </div>
              <div class="meta-info">
                <p>Gerado em: ${new Date().toLocaleDateString('pt-BR')} às ${new Date().toLocaleTimeString('pt-BR')}</p>
                <p>Solicitante: ${currentUser ? currentUser.name : 'Sistema'}</p>
              </div>
            </header>

            <div class="summary">
              <div class="card">
                <h3>${totalReports}</h3>
                <p>Total de Reports</p>
              </div>
              <div class="card" style="border-color: #10b981;">
                <h3>${sentReports}</h3>
                <p>Enviados</p>
              </div>
              <div class="card" style="border-color: #f59e0b;">
                <h3>${pendingReports}</h3>
                <p>Pendentes</p>
              </div>
              <div class="card" style="border-color: #8b5cf6;">
                <h3>${totalKm.toFixed(1)} km</h3>
                <p>Total Rodado</p>
              </div>
            </div>

            <table>
              <thead>
                <tr>
                  <th>Condutor</th>
                  <th>Placa</th>
                  <th>Data</th>
                  <th>Destino</th>
                  <th>KM Inicial</th>
                  <th>KM Final</th>
                  <th>Distância</th>
                  <th>Status</th>
                  <th>Lotação</th>
                  <th>Responsável</th>
                </tr>
              </thead>
              <tbody>
                ${records.map(r => {
                  const dist = (r.km_final !== null && r.km_final > r.km_inicial) 
                    ? (r.km_final - r.km_inicial).toFixed(1) + ' km' 
                    : '-';
                  const kmFinal = r.km_final ? r.km_final.toFixed(1) + ' km' : '-';
                  const statusClass = r.status === 'Enviado' ? 'enviado' : 'pendente';
                  
                  return `
                  <tr>
                    <td><strong>${r.condutor}</strong></td>
                    <td>${r.placa}</td>
                    <td>${formatDate(r.data)}</td>
                    <td>${r.destino}</td>
                    <td>${r.km_inicial.toFixed(1)} km</td>
                    <td>${kmFinal}</td>
                    <td style="font-weight:bold; color: #253d70;">${dist}</td>
                    <td><span class="badge ${statusClass}">${r.status}</span></td>
                    <td>${r.user_location || '-'}</td>
                    <td>${r.responsavel_unidade || '-'}</td>
                  </tr>
                  `;
                }).join('')}
              </tbody>
            </table>

            <div class="footer">
              <p>Este documento é um relatório gerado automaticamente pelo Sistema de Controle de Tráfego.</p>
              <p>SEMCAS - Secretaria Municipal da Criança e Assistência Social</p>
            </div>
          </div>
        </body>
        </html>
      `;

      // Criação do Blob e Download Automático
      const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      
      const fileName = `Relatorio_Trafego_${new Date().toISOString().split('T')[0]}.html`;
      
      link.href = url;
      link.download = fileName;
      document.body.appendChild(link);
      link.click();
      
      // Limpeza
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    function exportToExcel() {
      const records = getFilteredRecords();
      
      let htmlContent = `
        <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
        <head>
          <meta charset="UTF-8">
          <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
          <style>
            .header { 
              font-weight: bold; 
              font-size: 16px; 
              text-align: center; 
              background-color: #253d70; 
              color: white; 
              padding: 10px;
            }
            .subheader { 
              font-weight: bold; 
              font-size: 14px; 
              text-align: center; 
              background-color: #f8f9fa; 
              padding: 8px;
            }
            .summary { 
              background-color: #e3f2fd; 
              font-weight: bold; 
              text-align: center; 
              padding: 5px;
            }
            table { 
              border-collapse: collapse; 
              width: 100%; 
              font-family: Arial, sans-serif;
            }
            th { 
              background-color: #253d70; 
              color: white; 
              font-weight: bold; 
              text-align: center; 
              padding: 8px; 
              border: 1px solid #000;
            }
            td { 
              padding: 6px; 
              border: 1px solid #ccc; 
              text-align: left;
            }
            .number { text-align: right; }
            .center { text-align: center; }
            .status-enviado { background-color: #d1fae5; color: #065f46; font-weight: bold; }
            .status-pendente { background-color: #fef3c7; color: #92400e; font-weight: bold; }
          </style>
        </head>
        <body>
          <table>
            <tr>
              <td colspan="11" class="header">SISTEMA DE CONTROLE DE TRÁFEGO</td>
            </tr>
            <tr>
              <td colspan="11" class="subheader">COORDENAÇÃO DE SUPORTE E LOGÍSTICA - SEMCAS</td>
            </tr>
            <tr>
              <td colspan="11" class="subheader">Relatório Detalhado - ${new Date().toLocaleDateString('pt-BR')} às ${new Date().toLocaleTimeString('pt-BR')}</td>
            </tr>
            <tr><td colspan="11"></td></tr>
            
            <tr>
              <td colspan="3" class="summary">Total de Reports: ${records.length}</td>
              <td colspan="3" class="summary">Reports Enviados: ${records.filter(r => r.status === 'Enviado').length}</td>
              <td colspan="3" class="summary">Reports Pendentes: ${records.filter(r => r.status === 'Pendente').length}</td>
              <td colspan="2" class="summary">Total KM: ${records.reduce((sum, r) => sum + (r.km_final - r.km_inicial), 0).toFixed(1)} km</td>
            </tr>
            <tr><td colspan="11"></td></tr>
            
            <tr>
              <th>Condutor</th>
              <th>Placa</th>
              <th>Data</th>
              <th>Destino</th>
              <th>KM Inicial</th>
              <th>KM Final</th>
              <th>Distância (km)</th>
              <th>Status</th>
              <th>Lotação</th>
              <th>Responsável</th>
              <th>Tipo Unidade</th>
            </tr>
      `;

      records.forEach(record => {
        const kmFinal = record.km_final !== null ? record.km_final.toFixed(1) : 'Aguardando...';
        const distancia = record.km_final !== null ? (record.km_final - record.km_inicial).toFixed(1) : '-';
        const dataFormatada = new Date(record.data).toLocaleDateString('pt-BR');
        const responsavel = record.responsavel_unidade || '-';
        const tipoUnidade = record.tipo_unidade || '-';
        const statusClass = record.status === 'Enviado' ? 'status-enviado' : 'status-pendente';
        
        htmlContent += `
          <tr>
            <td>${record.condutor}</td>
            <td class="center">${record.placa}</td>
            <td class="center">${dataFormatada}</td>
            <td>${record.destino}</td>
            <td class="number">${record.km_inicial.toFixed(1)}</td>
            <td class="number">${kmFinal}</td>
            <td class="number">${distancia}</td>
            <td class="center ${statusClass}">${record.status}</td>
            <td>${record.user_location}</td>
            <td>${responsavel}</td>
            <td>${tipoUnidade}</td>
          </tr>
        `;
      });

      htmlContent += `
            <tr><td colspan="11"></td></tr>
            <tr>
              <td colspan="11" class="subheader">Relatório gerado por: Welligton Ferreira (Gestor) - Sistema de Controle de Tráfego</td>
            </tr>
          </table>
        </body>
        </html>
      `;

      const blob = new Blob([htmlContent], { 
        type: 'application/vnd.ms-excel;charset=utf-8' 
      });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `relatorio_trafego_${new Date().toISOString().split('T')[0]}.xls`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);

      showToast('Relatório Excel exportado com sucesso!', 'success');
    }
    
    function showBackupModal() {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal">
          <div class="modal-header">
            <h3 class="modal-title">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#253d70" stroke-width="2" style="vertical-align: middle; margin-right: 8px;">
                <ellipse cx="12" cy="5" rx="9" ry="3"/>
                <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/>
                <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/>
              </svg>
              Gerenciamento de Dados
            </h3>
            <p class="modal-subtitle">Faça backup ou restaure os dados do sistema</p>
          </div>
          
          <div style="display: grid; gap: 1rem; margin-bottom: 1.5rem;">
            <div style="background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 8px; padding: 1rem;">
              <h4 style="margin: 0 0 0.5rem 0; color: #0c4a6e;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#0c4a6e" stroke-width="2" style="vertical-align: middle; margin-right: 6px;">
                  <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                  <polyline points="7,10 12,15 17,10"/>
                  <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
                Fazer Backup
              </h4>
              <p style="margin: 0 0 1rem 0; font-size: 0.875rem; color: #0369a1;">
                Baixe todos os dados do sistema (usuários, registros, configurações)
              </p>
              <button class="btn btn-primary" onclick="exportBackup()" style="width: 100%;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                  <polyline points="7,10 12,15 17,10"/>
                  <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
                Fazer Backup
              </button>
            </div>
            
            <div style="background: #f0fdf4; border: 1px solid #22c55e; border-radius: 8px; padding: 1rem;">
              <h4 style="margin: 0 0 0.5rem 0; color: #14532d;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#14532d" stroke-width="2" style="vertical-align: middle; margin-right: 6px;">
                  <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                  <polyline points="17,10 12,5 7,10"/>
                  <line x1="12" y1="5" x2="12" y2="19"/>
                </svg>
                Restaurar Backup
              </h4>
              <p style="margin: 0 0 1rem 0; font-size: 0.875rem; color: #166534;">
                Carregue um arquivo de backup para restaurar os dados
              </p>
              <input type="file" id="backup-file-input" accept=".json" style="margin-bottom: 1rem; width: 100%;">
              <button class="btn btn-secondary" onclick="importBackup()" style="width: 100%;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                  <polyline points="17,10 12,5 7,10"/>
                  <line x1="12" y1="5" x2="12" y2="19"/>
                </svg>
                Restaurar Backup
              </button>
            </div>
          </div>

          <div class="button-group">
            <button class="btn btn-danger" onclick="closeBackupModal()">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 6L6 18M6 6l12 12"/>
              </svg>
              Fechar
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      window.currentBackupModal = modal;
    }

    function closeBackupModal() {
      if (window.currentBackupModal) {
        window.currentBackupModal.remove();
        window.currentBackupModal = null;
      }
    }

    function exportBackup() {
      const backupData = DataStorage.exportAllData();
      if (!backupData) {
        showToast('Erro ao gerar backup', 'error');
        return;
      }

      const blob = new Blob([backupData], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `backup_sistema_trafego_${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);

      showToast('Backup realizado com sucesso!', 'success');
      closeBackupModal();
    }

    function importBackup() {
      const fileInput = document.getElementById('backup-file-input');
      const file = fileInput.files[0];
      
      if (!file) {
        showToast('Selecione um arquivo de backup', 'error');
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const success = DataStorage.importAllData(e.target.result);
          if (success) {
            registeredUsers = DataStorage.loadUsers();
            loadLocalData();
            loadManagerPhoto();
            showToast('Backup restaurado com sucesso! Recarregue a página.', 'success');
            closeBackupModal();
          } else {
            showToast('Erro ao restaurar backup. Verifique o arquivo.', 'error');
          }
        } catch (error) {
          showToast('Arquivo de backup inválido', 'error');
        }
      };
      reader.readAsText(file);
    }

    function showStorageStats() {
      const stats = DataStorage.getStorageStats();
      if (!stats) {
        showToast('Erro ao obter estatísticas', 'error');
        return;
      }

      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal">
          <div class="modal-header">
            <h3 class="modal-title">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#253d70" stroke-width="2" style="vertical-align: middle; margin-right: 8px;">
                <line x1="18" y1="20" x2="18" y2="10"/>
                <line x1="12" y1="20" x2="12" y2="4"/>
                <line x1="6" y1="20" x2="6" y2="14"/>
              </svg>
              Estatísticas de Armazenamento
            </h3>
            <p class="modal-subtitle">Uso atual do armazenamento local</p>
          </div>
          
          <div style="display: grid; gap: 1rem; margin-bottom: 1.5rem;">
            <div class="route-summary">
              <div class="route-item">
                <span class="route-label">Usuários cadastrados:</span>
                <span class="route-value">${stats.users}</span>
              </div>
              <div class="route-item">
                <span class="route-label">Registros de tráfego:</span>
                <span class="route-value">${stats.records}</span>
              </div>
              <div class="route-item">
                <span class="route-label">Foto do gestor:</span>
                <span class="route-value">${stats.managerPhoto}</span>
              </div>
              <div class="route-item">
                <span class="route-label">Total utilizado:</span>
                <span class="route-value"><strong>${stats.total}</strong></span>
              </div>
              <div class="route-item">
                <span class="route-label">Porcentagem usada:</span>
                <span class="route-value"><strong>${stats.percentage}%</strong></span>
              </div>
              <div class="route-item">
                <span class="route-label">Espaço disponível:</span>
                <span class="route-value">${stats.available}</span>
              </div>
            </div>
            
            <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 1rem;">
              <p style="margin: 0; font-size: 0.875rem; color: #92400e;">
                <strong>Dica:</strong> Faça backup regularmente dos dados. Se o armazenamento estiver acima de 80%, considere limpar registros antigos.
              </p>
            </div>
          </div>

          <div class="button-group">
            <button class="btn btn-primary" onclick="closeStatsModal()">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 6L9 17l-5-5"/>
              </svg>
              Entendi
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      window.currentStatsModal = modal;
    }

    function closeStatsModal() {
      if (window.currentStatsModal) {
        window.currentStatsModal.remove();
        window.currentStatsModal = null;
      }
    }
    function showStorageStats() {
      showToast('Estatísticas agora são gerenciadas pelo Firebase', 'success');
    }
    
    function filterAnalyticsByPeriod(period) {
      updateBIAnalytics();
    }

    // =================================================================
    //  MÓDULO DE INTELIGÊNCIA E ANÁLISE AVANÇADA (ATIVADO)
    // =================================================================

   // --- COLE ESTE BLOCO NO FINAL DO SCRIPT (SUBSTITUINDO AS FUNÇÕES VAZIAS) ---

    function showPredictiveAnalysis() {
      if (allRecords.length < 3) { // Reduzi para 3 para facilitar testes
        showToast('Insira mais alguns registros para gerar previsões.', 'error');
        return;
      }

      const predictions = calculatePredictions();
      
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      
      const trendIcon = predictions.efficiencyTrend >= 0 ? 
        '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2"><path d="M23 6l-9.5 9.5-5-5L1 18"/><path d="M17 6h6v6"/></svg>' : 
        '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2"><path d="M23 18l-9.5-9.5-5 5L1 6"/><path d="M17 18h6v-6"/></svg>';
      
      const trendColor = predictions.efficiencyTrend >= 0 ? '#10b981' : '#ef4444';
      const trendText = predictions.efficiencyTrend >= 0 ? 'Melhorando' : 'Caindo';

      modal.innerHTML = `
        <div class="modal" style="max-width: 700px;">
          <div class="modal-header">
            <h3 class="modal-title">🔮 Análise Preditiva (Próximos 30 Dias)</h3>
            <p class="modal-subtitle">Estimativas baseadas no histórico de uso</p>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
            <div class="dashboard-card" style="flex-direction: column; align-items: flex-start; padding: 1rem;">
               <div style="font-size: 0.85rem; color: #64748b;">Previsão de Reports</div>
               <div style="font-size: 1.8rem; font-weight: bold; color: #253d70;">~${predictions.nextMonthReports}</div>
               <div style="font-size: 0.75rem; color: #10b981;">Baseado em ${predictions.dailyAvg.toFixed(1)} reports/dia</div>
            </div>

            <div class="dashboard-card" style="flex-direction: column; align-items: flex-start; padding: 1rem;">
               <div style="font-size: 0.85rem; color: #64748b;">Previsão de KM</div>
               <div style="font-size: 1.8rem; font-weight: bold; color: #3b82f6;">~${predictions.nextMonthKM.toLocaleString('pt-BR')} km</div>
            </div>
          </div>

          <div style="background: #f8fafc; border-left: 4px solid ${trendColor}; padding: 1rem; border-radius: 6px; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 1rem;">
             <div style="background: white; padding: 8px; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">${trendIcon}</div>
             <div>
                <h4 style="margin: 0; color: #1e293b;">Tendência de Eficiência: ${trendText}</h4>
                <p style="margin: 5px 0 0; font-size: 0.9rem; color: #64748b;">
                  Variação de <strong>${predictions.efficiencyTrend.toFixed(1)}%</strong> recentemente.
                </p>
             </div>
          </div>

          <div class="insight-card warning">
             <div class="insight-icon">💡</div>
             <div class="insight-content">
               <h4>Sugestão do Sistema</h4>
               <p>${predictions.recommendation}</p>
             </div>
          </div>

          <div class="button-group" style="margin-top: 1.5rem;">
            <button class="btn btn-primary" onclick="closePredictiveModal()" style="width: 100%;">Fechar Análise</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      window.currentPredictiveModal = modal;
    }

    function calculatePredictions() {
      const now = new Date();
      const thirtyDaysAgo = new Date();
      thirtyDaysAgo.setDate(now.getDate() - 30);
      
      const recentRecords = allRecords.filter(r => {
        if(!r.data) return false;
        const parts = r.data.split('-');
        const d = new Date(parts[0], parts[1]-1, parts[2]);
        return d >= thirtyDaysAgo;
      });

      const dataset = recentRecords.length > 0 ? recentRecords : allRecords;
      const periodDays = recentRecords.length > 0 ? 30 : 1;

      const dailyAvg = dataset.length / periodDays;
      const nextMonthReports = Math.ceil(dailyAvg * 30);

      const totalKm = dataset.reduce((sum, r) => {
         if (r.km_final && r.km_final > r.km_inicial) return sum + (r.km_final - r.km_inicial);
         return sum;
      }, 0);
      const nextMonthKM = Math.ceil((totalKm / (dataset.length || 1)) * nextMonthReports) || 0;

      const half = Math.floor(dataset.length / 2);
      const firstHalf = dataset.slice(0, half);
      const secondHalf = dataset.slice(half);

      const getEfficiency = (arr) => {
        if (!arr.length) return 0;
        const sent = arr.filter(r => r.status === 'Enviado').length;
        return (sent / arr.length) * 100;
      };

      const oldEff = getEfficiency(firstHalf);
      const newEff = getEfficiency(secondHalf);
      const efficiencyTrend = newEff - oldEff;

      let recommendation = "O fluxo está estável. Continue monitorando.";
      if (efficiencyTrend < -10) recommendation = "A taxa de envios caiu. Verifique pendências.";
      else if (efficiencyTrend > 10) recommendation = "A eficiência operacional está aumentando.";
      
      return { nextMonthReports, nextMonthKM, dailyAvg, efficiencyTrend, recommendation };
    }

    function detectAnomalies() {
      const anomalies = [];
      // 1. KM Alto
      allRecords.forEach(r => {
        if (r.km_final && (r.km_final - r.km_inicial) > 400) {
          anomalies.push({
            type: 'high_km', title: 'Distância Alta', severity: 'danger',
            desc: `${r.placa} rodou ${(r.km_final - r.km_inicial).toFixed(0)}km em uma rota.`
          });
        }
      });
      // 2. Inatividade
      const lastSeen = {};
      allRecords.forEach(r => {
          if (!lastSeen[r.placa] || r.data > lastSeen[r.placa]) lastSeen[r.placa] = r.data;
      });
      const today = new Date();
      Object.keys(lastSeen).forEach(placa => {
        const parts = lastSeen[placa].split('-');
        const lastDate = new Date(parts[0], parts[1]-1, parts[2]);
        const diffDays = Math.ceil(Math.abs(today - lastDate) / (1000 * 60 * 60 * 24));
        if (diffDays > 15) {
           anomalies.push({
            type: 'inactivity', title: 'Veículo Parado', severity: 'warning',
            desc: `${placa} sem atividade há ${diffDays} dias.`
          });
        }
      });

      showAnomaliesModal(anomalies);
    }

    function showAnomaliesModal(anomalies) {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      let content = anomalies.length === 0 ? 
        '<div class="empty-state" style="padding:2rem;text-align:center;"><h3>✅ Tudo Certo!</h3><p>Nenhuma anomalia detectada.</p></div>' : 
        `<div style="display:flex;flex-direction:column;gap:10px;">${anomalies.map(a => 
          `<div class="insight-card ${a.severity}" style="padding:1rem;"><h4>${a.title}</h4><p>${a.desc}</p></div>`
        ).join('')}</div>`;

      modal.innerHTML = `
        <div class="modal" style="max-width: 600px;">
          <div class="modal-header"><h3 class="modal-title">⚠️ Anomalias</h3></div>
          ${content}
          <div class="button-group" style="margin-top:1.5rem;"><button class="btn btn-primary" onclick="closeAnomaliesModal()" style="width:100%;">Fechar</button></div>
        </div>`;
      document.body.appendChild(modal);
      window.currentAnomaliesModal = modal;
    }

    function getAnomalyTitle(type) { return type; } // Placeholder simples
    
    function closePredictiveModal() {
      if (window.currentPredictiveModal) { window.currentPredictiveModal.remove(); window.currentPredictiveModal = null; }
    }
    function closeAnomaliesModal() {
      if (window.currentAnomaliesModal) { window.currentAnomaliesModal.remove(); window.currentAnomaliesModal = null; }
    }

    // Funções globais para os modais
    window.exportBackup = exportBackup;
    window.importBackup = importBackup;
    window.closeBackupModal = closeBackupModal;
    window.closeStatsModal = closeStatsModal;
    window.closePredictiveModal = closePredictiveModal;
    window.closeAnomaliesModal = closeAnomaliesModal;

// =============================================================
    //  LÓGICA DO MÓDULO DE CONDUTORES (CARD + EXPORTAÇÃO)
    // =============================================================

    let cachedUsersList = null;

    // 1. Busca a contagem inicial para o Card
    async function fetchDriverStats() {
      try {
        // Se o campo 'type' não existir em alguns users, remova o .where ou ajuste conforme seu banco
        const usersSnapshot = await db.collection("users").where("type", "==", "condutor").get();
        const count = usersSnapshot.size;
        
        const cardEl = document.getElementById('total-registered-drivers');
        if (cardEl) cardEl.textContent = count;
        
        cachedUsersList = usersSnapshot.docs.map(doc => doc.data());
      } catch (error) {
        console.error("Erro ao buscar condutores:", error);
      }
    }

    // 2. Helper: Processa os dados (cruza Usuários com Registros)
    function getProcessedDriversData() {
      if (!cachedUsersList) return [];

      const driverPlates = {};
      const driverActivity = {}; 
      const lastDate = {};

      // Mapeia a atividade baseada nos registros carregados na memória (allRecords)
      allRecords.forEach(record => {
        if (!driverPlates[record.condutor]) {
          driverPlates[record.condutor] = record.placa; // Pega a mais recente pois allRecords é desc
        }
        driverActivity[record.condutor] = true;
        
        // Salva a data mais recente
        if (!lastDate[record.condutor] || record.data > lastDate[record.condutor]) {
          lastDate[record.condutor] = record.data;
        }
      });

      return cachedUsersList.map(user => {
        const displayName = user.nickname || user.name;
        // Tenta achar pelo apelido ou pelo nome completo
        const plate = driverPlates[displayName] || driverPlates[user.name] || '-';
        const isActive = driverActivity[displayName] || driverActivity[user.name];
        const lastSeen = lastDate[displayName] || lastDate[user.name] || null;

        return {
          name: user.name,
          email: user.email,
          location: user.location || 'Não informado',
          plate: plate,
          active: isActive,
          lastSeen: lastSeen
        };
      });
    }

    // 3. Exibir Modal e Tabela
    function showDriversDetails() {
      if (!cachedUsersList) {
        showToast("Carregando dados...", "warning");
        fetchDriverStats().then(showDriversDetails); // Tenta buscar e reabrir
        return;
      }

      const tbody = document.getElementById('drivers-list-tbody');
      const data = getProcessedDriversData();

      tbody.innerHTML = data.map(d => {
        // Formatação da data se existir
        let dataTexto = 'Recente';
        if (d.lastSeen) {
            const parts = d.lastSeen.split('-');
            if (parts.length === 3) dataTexto = `${parts[2]}/${parts[1]}/${parts[0]}`;
        }

        const statusBadge = d.active 
          ? `<span class="status-badge status-enviado">Ativo (${dataTexto})</span>` 
          : '<span class="status-badge" style="background:#f3f4f6; color:#6b7280;">Sem registros</span>';
        
        const plateStyle = d.plate !== '-' ? 'font-weight:600; color:#253d70;' : 'color:#9ca3af; font-style:italic;';

        return `
          <tr>
            <td>
              <strong>${d.name}</strong>
              <div style="font-size:0.75rem; color:#64748b;">${d.email}</div>
            </td>
            <td>${d.location}</td>
            <td style="text-align:center; ${plateStyle}">${d.plate}</td>
            <td>${statusBadge}</td>
          </tr>
        `;
      }).join('');

      document.getElementById('drivers-details-modal').classList.remove('hidden');
    }

    // 4. Exportar para Excel
    function exportDriversToExcel() {
      const data = getProcessedDriversData();
      if (data.length === 0) { showToast('Sem dados para exportar', 'error'); return; }

      let htmlContent = `
        <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
        <head>
          <meta charset="UTF-8">
          <style>
            th { background-color: #253d70; color: white; border: 1px solid #000; padding: 5px; }
            td { border: 1px solid #ccc; padding: 5px; }
          </style>
        </head>
        <body>
          <table>
            <tr><th colspan="5" style="font-size:14px;">RELAÇÃO DE CONDUTORES CADASTRADOS</th></tr>
            <tr>
              <th>Nome Completo</th>
              <th>Email</th>
              <th>Lotação</th>
              <th>Última Placa</th>
              <th>Status</th>
            </tr>
            ${data.map(d => `
              <tr>
                <td>${d.name}</td>
                <td>${d.email}</td>
                <td>${d.location}</td>
                <td style="text-align:center;">${d.plate}</td>
                <td style="text-align:center;">${d.active ? 'Ativo' : 'Inativo'}</td>
              </tr>
            `).join('')}
          </table>
        </body></html>`;

      const blob = new Blob([htmlContent], { type: 'application/vnd.ms-excel;charset=utf-8' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `condutores_cadastrados_${new Date().toISOString().split('T')[0]}.xls`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // 5. Exportar para HTML (Relatório Bonito)
    function exportDriversToHTML() {
      const data = getProcessedDriversData();
      if (data.length === 0) { showToast('Sem dados para exportar', 'error'); return; }

      const logoSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 640 640" fill="#253d70"><path d="M541.9 139.5C546.4 127.7 543.6 114.3 534.7 105.4C525.8 96.5 512.4 93.6 500.6 98.2L84.6 258.2C71.9 263 63.7 275.2 64 288.7C64.3 302.2 73.1 314.1 85.9 318.3L262.7 377.2L321.6 554C325.9 566.8 337.7 575.6 351.2 575.9C364.7 576.2 376.9 568 381.8 555.4L541.8 139.4z"/></svg>`;

      const htmlContent = `
        <!DOCTYPE html>
        <html lang="pt-BR">
        <head>
          <meta charset="UTF-8">
          <title>Relatório de Condutores</title>
          <style>
            body { font-family: 'Segoe UI', sans-serif; padding: 40px; max-width: 1000px; margin: 0 auto; background: #f8fafc; color: #333; }
            .container { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
            .header { display: flex; align-items: center; gap: 20px; border-bottom: 2px solid #e2e8f0; padding-bottom: 20px; margin-bottom: 30px; }
            .title h1 { margin: 0; color: #1e293b; font-size: 22px; }
            .title p { margin: 5px 0 0; color: #64748b; font-size: 14px; }
            table { width: 100%; border-collapse: collapse; }
            thead { background: #1e293b; color: white; }
            th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e2e8f0; font-size: 13px; }
            .badge { padding: 4px 8px; border-radius: 12px; font-size: 10px; font-weight: bold; text-transform: uppercase; }
            .ativo { background: #dcfce7; color: #166534; }
            .inativo { background: #f1f5f9; color: #64748b; }
          </style>
        </head>
        <body>
          <div class="container">
            <div class="header">
              ${logoSvg}
              <div class="title">
                <h1>Relatório de Condutores Cadastrados</h1>
                <p>SEMCAS - Coordenação de Suporte e Logística</p>
              </div>
            </div>
            <table>
              <thead>
                <tr><th>Nome</th><th>Email</th><th>Lotação</th><th>Última Placa</th><th>Status</th></tr>
              </thead>
              <tbody>
                ${data.map(d => `
                  <tr>
                    <td><b>${d.name}</b></td>
                    <td>${d.email}</td>
                    <td>${d.location}</td>
                    <td style="text-align:center">${d.plate}</td>
                    <td><span class="badge ${d.active ? 'ativo' : 'inativo'}">${d.active ? 'Ativo' : 'Sem registro'}</span></td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </body></html>`;

      const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `relatorio_condutores_${new Date().toISOString().split('T')[0]}.html`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
    // Inicialização do sistema
    document.addEventListener('DOMContentLoaded', function() {
      initializeApp();
    });

  </script>
</body>
</html>